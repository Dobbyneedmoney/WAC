<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>예약 변경</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://code.jquery.com/jquery-latest.js"></script>
  <style>
    #calendar { max-width:300px; margin-bottom:1rem; }
    .times-grid { display:flex; flex-wrap:wrap; gap:.5rem; }
    .times-grid button {
      padding:.5rem 1rem; border:1px solid #ccc;
      background:#f5f5f5; cursor:pointer;
    }
    .times-grid button.selected {
      background:#0078d4; color:#fff; border-color:#005a9e;
    }
    .times-grid button.disabled {
      background:#eee; color:#999; border-color:#ddd;
      cursor:not-allowed;
    }
  </style>
</head>
<body>
  <h1>예약 변경</h1>
  <p>
    면접관: <span th:text="${reservation.intrId}">hong</span>
    (예약번호: <span th:text="${reservation.resId}">7</span>)
  </p>

  <!-- 1) 달력 -->
  <div id="calendar"></div>
  <!-- 2) 시간 버튼 -->
  <div class="times-grid" id="times-grid"></div>
  <!-- 3) 확정 -->
  <button id="btn-confirm" style="margin-top:1rem;">확인</button>

  <script th:inline="javascript">
    /*[[*/
    var intrId       = /*[[${reservation.intrId}]]*/ 'hong';
    var resId        = /*[[${reservation.resId}]]*/     0;
    var reservedSlots= /*[[${reservedSlots}]]*/       {};
    /*]]*/

    var selectedDate = null,
        selectedTime = null;

    // 달력 초기화
    flatpickr("#calendar", {
      inline: true,
      dateFormat: "Y-m-d",
      onChange: function(_, dateStr) {
        selectedDate = dateStr;
        renderTimes();
      }
    });

    // 시간 버튼 렌더링
    function renderTimes(){
      var grid    = $('#times-grid').empty();
      var blocked = reservedSlots[selectedDate]||[];
      for(var h=9; h<=17; h++){
        var t = (h<10?'0':'')+h+':00';
        $('<button>')
          .text(t)
          .addClass(blocked.includes(t)?'disabled':'')
          .on('click', function(){
            var me = $(this), tt = me.text();
            if(blocked.includes(tt)) return;
            $('.times-grid button').removeClass('selected');
            me.addClass('selected');
            selectedTime = tt;
          })
          .appendTo(grid);
      }
    }

    // 확인 버튼 → 한 줄 GET 호출
    $('#btn-confirm').on('click', function(){
      if(!selectedDate||!selectedTime){
        return alert('날짜와 시간을 모두 선택해주세요.');
      }
      window.location.href =
        /*[[@{/reservation/reschedule}]]*/ '/reservation/reschedule'
        + '?resId='        + resId
        + '&reservedDate=' + selectedDate
        + '&reservedTime=' + selectedTime;
    });
  </script>
</body>
</html>
