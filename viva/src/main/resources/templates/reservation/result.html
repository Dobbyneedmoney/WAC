<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>예약 결과</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" th:href="@{/css/common.css}">
<link rel="stylesheet" href="/css/book.css" />
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
</head>
<body>
	<div th:replace="fragments/header :: headerFragment"></div>

	
  <div class="result-wrapper">
    <h1>예약 결과</h1>

    <div th:if="${reservation != null}">
      <table class="reservation-result-table">
        <tr>
          <th>예약번호</th>
          <td th:text="${reservation.resId}">—</td>
        </tr>
        <tr>
          <th>예약일시</th>
          <td>
            <span th:text="${reservation.reservedDate}">yyyy-MM-dd</span>
            <span th:text="${reservation.reservedTime}">HH:mm</span>
          </td>
        </tr>
        <tr>
          <th>상태</th>
          <td>
            <span th:switch="${reservation.resStatus}">
              <span th:case="'pending'">결제 대기</span>
              <span th:case="'confirmed'">결제 완료</span>
              <span th:case="'cancelled'">취소됨</span>
              <span th:case="*">-</span>
            </span>
          </td>
        </tr>
      </table>

			<!-- 카드 결제 링크 -->
			  <div class="btn-group" th:if="${reservation.resStatus == 'pending'}">
				  <button type="button" class="btn-card btn-pay" 
                th:data-resid="${reservation.resId}">
          💳 카드 결제
        </button>
			<!-- ✅ 포인트 결제 버튼 -->
				 <button id="btn-point-pay" th:data-userid="${userId}"
          th:data-resid="${reservation.resId}" data-amount="5000" class="btn-point">
          💰 포인트로 결제
        </button>
			</div>
		</div>

		<div th:if="${reservation == null}">
			<p>예약 정보를 찾을 수 없습니다.</p>
			<p th:text="${error}"></p>
		</div>

		<p>
			<a th:href="@{/mypage(tab='schedule')}" class="back-link">내 예약 목록으로 돌아가기</a>
		</p>
	</div>

	<!-- ✅ 포인트 결제 AJAX -->
	 <script>
    $('#btn-point-pay').on('click', function() {
      const userId = $(this).data('userid');
      const resId = $(this).data('resid');
      const amount = $(this).data('amount');

      if (!confirm(amount + ' 포인트로 결제하시겠습니까?')) return;

      $.ajax({
        type: 'POST',
        url: '/point/use',
        data: { userId, resId, amount },
        success: function(response) {
          alert("포인트 결제 완료!");
          location.href = "/reservation/mylist";
        },
        error: function(xhr) {
          alert("결제 실패: " + xhr.responseText);
        }
      });
    });
  </script>

  <!-- 카드 결제 아임포트 연동 -->
  <script>
    $(function(){
      IMP.init("imp14397622"); // 아임포트 가맹점 식별코드

      $(document).on('click', '.btn-pay.btn-card', function(e) {
        e.preventDefault();

        const resId = $(this).data('resid');
        const userId = /*[[${userId}]]*/ 'UNKNOWN'; // 서버에서 세션 등으로 받을 것
        const amount = 5000; // 결제 금액 (필요 시 동적으로 변경)

        IMP.request_pay({
          channelKey : "channel-key-01764171-b249-4c16-9d18-e9174fa8e611",
          pay_method: 'card',
          merchant_uid: 'order_' + new Date().getTime(),
          name: '면접 예약 결제',
          amount: amount,
          buyer_tel: '010-0000-0000'
        }, function(rsp) {
          if (!rsp.success) {
            alert('결제 실패: ' + rsp.error_msg);
            return;
          }

          // 결제 성공 시 서버에 결제 정보 저장 요청
          $.ajax({
            type: 'POST',
            url: '/payment/save',
            contentType: 'application/json',
            data: JSON.stringify({
              payResno: rsp.merchant_uid,
              payAmount: rsp.paid_amount,
              payStatus: rsp.status,
              resId: resId,
              userId: userId,
              payType: "CARD"
            }),
            success: function(data) {
              alert('카드결제 완료');
              location.href = "/mypage?tab=schedule";
            },
            error: function(xhr) {
              alert('서버 통신 중 오류가 발생했습니다.');
            }
          });
        });
      });
    });
	</script>


	<div th:replace="fragments/footer :: footerFragment"></div>

</body>
</html>
