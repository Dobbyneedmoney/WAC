<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>화상 면접 SPA</title>

<style>
/* main-view, new-view, list-view는 각각 숨김처리 */
.view {
	display: none;
}

.view.active {
	display: block;
}

body {
	font-family: 'Arial', sans-serif;
	background-color: #f2f2f2;
	padding: 20px;
}

/* ================================== */
header, footer {
	background-color: #cfd8ff;
	padding: 10px 20px;
	text-align: center;
}

header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	font-weight: bold;
}

.logo {
	font-size: 1.2rem;
}

.login-link {
	font-size: 0.9rem;
}

main {
	background-color: #ffffff;
	min-height: 400px;
	display: flex;
	justify-content: center;
	align-items: center;
	padding: 40px 0;
}

.content-box {
	border: 1px solid #d0d0d0;
	border-radius: 6px;
	padding: 30px 50px;
	text-align: center;
}

.content-box h2 {
	margin-bottom: 30px;
	font-size: 1.4rem;
}

.button-group {
	display: flex;
	gap: 20px;
	justify-content: center;
}

.nav-button {
	width: 120px;
	height: 100px;
	background-color: #e0e0e0;
	border: none;
	border-radius: 6px;
	font-size: 1rem;
	font-weight: bold;
	cursor: pointer;
	transition: background-color 0.2s;
}

.nav-button:hover {
	background-color: #d6d6d6;
}

footer {
	font-weight: bold;
}

/* ================================== */
.room-list {
	display: flex;
	flex-wrap: wrap;
	gap: 20px;
}

.room-card {
	background-color: #fff;
	width: 300px;
	border-radius: 12px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	padding: 16px;
	position: relative;
}

.room-status-dot {
	width: 10px;
	height: 10px;
	border-radius: 50%;
	display: inline-block;
	margin-right: 8px;
}

.status-waiting {
	background-color: red;
}

.status-playing {
	background-color: green;
}

.status-ended {
	background-color: gray;
}

.room-title {
	font-size: 1.1rem;
	font-weight: bold;
	margin: 8px 0;
}

.room-info {
	color: #666;
	font-size: 0.9rem;
	margin-top: 4px;
}

.room-icon {
	position: absolute;
	bottom: 16px;
	right: 16px;
	font-size: 1.2rem;
}

.room-list a {
	text-decoration: none;
	color: inherit;
}

.room-list a:hover {
	transform: translateY(-4px);
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/*** 비디오 영역 css ***/
#videoroom-view {
	padding: 20px;
}

#local-area, #remote-area {
	margin-bottom: 20px;
}

.label {
	font-size: 14px;
	background-color: #3498db;
	color: #fff;
	padding: 2px 6px;
	border-radius: 3px;
}

.hide {
	display: none;
}

.remote-grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
	gap: 10px;
}

.remote-box {
	position: relative;
	border: 1px solid #ccc;
	padding: 5px;
	min-height: 150px;
}

.remote-box video {
  background-color: black;
  width: 100%;
  height: 240px; /* 또는 auto, fixed 등 */
  object-fit: cover;
}

.bitrate-controls {
	margin-left: 10px;
	display: inline-block;
	position: relative;
}

.dropdown-menu {
	list-style: none;
	position: absolute;
	background: #fff;
	border: 1px solid #aaa;
	margin: 0;
	padding: 0;
	display: none;
}

.dropdown-menu li {
	padding: 5px 10px;
}

.dropdown-menu li:hover {
	background-color: #f0f0f0;
}

#bitrateset:hover+.dropdown-menu, .dropdown-menu:hover {
	display: block;
}

.remote-box video {
  width: 100%;
  max-width: 480px;       /* 👈 원하는 너비 제한 */
  height: auto;
  aspect-ratio: 4 / 3;     /* 또는 16 / 9 등 비율 고정 */
  object-fit: cover;       /* contain or cover */
}

</style>
<!-- 외부 라이브러리 -->
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js}"></script>
<script
	th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.4.0/bootbox.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js}"></script>



<!-- 내부 라이브러리 -->
<script th:src="@{/js/webRtc/janus.js}"></script>

<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css}" />
<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css}" />


</head>
<body>

	<!-- [1] 메인 화면 -->
	<div id="main-view" class="view active">
		<header>
			<div class="logo">로고</div>
			<div class="login-link">
				<a href="/login">로그인</a>
			</div>
		</header>
		<main>
			<div class="content-box">
				<h2>면접 메인</h2>
				<div class="button-group">
					<script>
						console.log("[[${sessionId}]]");
					</script>
					<button class="nav-button" onclick="navigate('new')">New
						Meeting</button>
					<button class="nav-button" onclick="navigate('list')">Join</button>
				</div>
			</div>
		</main>
		<footer>푸터</footer>
	</div>

	<!-- [2] 방 생성 화면 -->
	<div id="new-view" class="view">
		<h2>면접 방 생성</h2>
		<script>
			console.log("[[${userId}]]");
		</script>
		<form id="createRoomForm">
			<label for="intrRoomTitle">방 제목:</label> 
			<input type="text" id="intrRoomTitle" name="intrRoomTitle" required />
			<input type="hidden" id="host_id" name="host_id" th:value="${userId}">
			<button type="submit">방생성</button>
		</form>
		<button onclick="navigate('main')">← 뒤로가기</button>
	</div>

	<!-- [3] 방 목록 화면 -->
	<div id="list-view" class="view">
		<h2>면접 방 목록</h2>
		<div id="roomList" class="room-list"></div>
		<button onclick="navigate('main')">← 뒤로가기</button>
	</div>

	<!-- [4] 통화방 화면 -->
	<div id="videoroom-view" class="view">
		<h2>화상 통화</h2>

		<div class="remote-grid" id="remoteContainer"></div>


		<!-- 로컬 비디오 -->
		<section id="local-area">
			<h3>
				내 화면 <span id="publisher" class="label hide"></span> <span
					class="bitrate-controls hide">
					<button id="bitrateset">Bandwidth ▼</button>
					<ul id="bitrate" class="dropdown-menu">
						<li><a href="#" id="0">No limit</a></li>
						<li><a href="#" id="128">128kbps</a></li>
						<li><a href="#" id="256">256kbps</a></li>
						<li><a href="#" id="512">512kbps</a></li>
						<li><a href="#" id="1024">1mbps</a></li>
						<li><a href="#" id="1500">1.5mbps</a></li>
						<li><a href="#" id="2000">2mbps</a></li>
					</ul>
				</span>
			</h3>
			<div id="videolocal">
				<video id="myVideo" autoplay muted playsinline width="320"
					height="240" border="1"></video>
			</div>
		</section>
		<button id="exitBtn">종료</button>
	</div>

<script>
//✅ 전역 상태 변수
var version = 1.2;
var server = null;
server = "https://janus.jsflux.co.kr/janus";
var janus = null;
var sfutest = null;
var mypvtid = null;
var opaqueId = "videoroom-" + Janus.randomString(12);
var selectedRoomId = null;
var displayName = null;
var feeds = [];
var isDestroying = false; // 중복 detach 방지용 플래그

// ✅ navigate 처리 (화면 전환 시 정리 포함)
function navigate(view) {
  document.querySelectorAll('.view').forEach(div => div.classList.remove('active'));
  document.getElementById(view + '-view').classList.add('active');

  if (view === 'list') loadRoomList();
  if (view === 'videoroom') initJanus(); // 방 입장 시 초기화
  
}

// ✅ 방 생성
const createForm = document.getElementById("createRoomForm");
if (createForm) {
  createForm.addEventListener("submit", function(e) {
    e.preventDefault();
    const title = document.getElementById("intrRoomTitle").value;
	const host_id = document.getElementById("host_id").value;
    fetch("/api/meeting/roomcreate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
    	  intrRoomTitle: title,
    	  hostId: host_id
      })
    })
    .then(res => res.json())
    .then(data => {
      alert(`방 생성 완료: ${data.intrRoomTitle}`);
      navigate('list');
    });
  });
}

// ✅ 방 목록
function loadRoomList() {
  fetch("/api/meeting/roomlist")
    .then(res => res.json())
    .then(data => {
      const listEl = document.getElementById("roomList");
      if (!listEl) return;
      listEl.innerHTML = "";

      data.forEach(room => {
        const statusClass = room.statusCd === 'waiting' ? 'status-waiting'
                          : room.statusCd === 'in_progress' ? 'status-playing'
                          : 'status-ended';

        const div = document.createElement("div");
        div.className = "room-card";
        div.innerHTML = `
          <div>
            <span class="room-status-dot ${statusClass}"></span>
            <span>${room.intrRoomId}</span>
          </div>
          <div class="room-title">${room.intrRoomTitle}</div>
          <div class="room-info">${room.hostId}님의 방</div>
          <div class="room-info">생성: ${formatDate(room.createdDt)}</div>
          <div class="room-icon">🔒 🔓</div>
        `;
        div.addEventListener("click", () => enterRoom(room.intrRoomId, room.hostId));
        listEl.appendChild(div);
      });
    });
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleString("ko-KR", {
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit'
  });
}

// ✅ 방 입장
function enterRoom(roomId, name) {
  selectedRoomId = roomId;
  displayName = name;
  navigate('videoroom');
}

// ✅ Janus 초기화
function initJanus() {
  if (!Janus.isWebrtcSupported()) {
    alert("WebRTC를 지원하지 않는 브라우저입니다.");
    return;
  }
  
  Janus.init({
    debug: "all",
    callback: createJanusSession
  });
}

// ✅ 세션 생성
function createJanusSession() {
  
	if (janus !== null) {
	    janus.destroy();
	    janus = null;
	  }
	  feeds = [];
	
  janus = new Janus({
    server: server,
    success: function () {
      janus.attach({
        plugin: "janus.plugin.videoroom",
        opaqueId: opaqueId,
        success: function (pluginHandle) {
          sfutest = pluginHandle;
          sfutest.send({
            message: {
              request: "join",
              room: selectedRoomId,
              ptype: "publisher",
              display: displayName
            }
          });
        },

        onmessage: function (msg, jsep) {
          if (msg.videoroom === "joined") {
            mypvtid = msg.private_id;
            publishOwnFeed();

            if (msg.publishers) {
              msg.publishers.forEach(pub => {
                if (!feeds.find(f => f.rfid === pub.id)) {
                  newRemoteFeed(pub.id, pub.display);
                }
              });
            }
          }

          if (jsep) sfutest.handleRemoteJsep({ jsep });
        },

        onlocalstream: function (stream) {		// 내 출력화면
          const localBox = `
            <div class="remote-box" id="local-box">
              <span>내 화면</span>
              <video id="localvideo" autoplay muted playsinline></video>
            </div>`;
          if (!document.getElementById('local-box')) {		// DOM 중복 삽입 방지
            $('#remoteContainer').append(localBox);
          }
          Janus.attachMediaStream(document.getElementById('localvideo'), stream);
        },

        oncleanup: cleanupAllFeeds,
        ondetached: cleanupAllFeeds,
        error: function (err) {
          console.error("Janus 오류", err);
        }
      });
    },

    destroyed: cleanupAllFeeds
  });
}

// ✅ 내 영상 publish
function publishOwnFeed() {
  sfutest.createOffer({
    media: { audioRecv: false, videoRecv: false, audioSend: true, videoSend: true },
    success: function (jsep) {
      sfutest.send({
        message: { request: "configure", audio: true, video: true },
        jsep
      });
    },
    error: function (error) {
      console.error("내 stream publish 실패", error);
    }
  });
}

// ✅ remote feed 추가
function newRemoteFeed(id, display) {
  if (feeds.find(f => f.rfid === id)) return;

  janus.attach({
    plugin: "janus.plugin.videoroom",
    opaqueId,

    success: function (pluginHandle) {
      const remoteFeed = pluginHandle;
      remoteFeed.rfid = id;
      remoteFeed.rfdisplay = display;

      feeds.push(remoteFeed);

      remoteFeed.send({
        message: {
          request: "join",
          room: selectedRoomId,
          ptype: "subscriber",
          feed: id,
          private_id: mypvtid
        }
      });
    },

    onmessage: function (msg, jsep) {
      if (jsep) {
        feeds.find(f => f.rfid === id)?.createAnswer({
          jsep,
          media: { audioSend: false, videoSend: false },
          success: function (jsep) {
            feeds.find(f => f.rfid === id)?.send({ message: { request: "start", room: selectedRoomId }, jsep });
          },
          error: function (err) {
            console.error("remote SDP 오류", err);
          }
        });
      }
    },

    onremotestream: function (stream) {
      if (document.getElementById(`remote-box-${id}`)) return;

      const html = `
        <div class="remote-box" id="remote-box-${id}">
          <span>${display}</span>
          <video id="remotevideo-${id}" autoplay playsinline></video>
        </div>`;
      $('#remoteContainer').append(html);
      Janus.attachMediaStream(document.getElementById(`remotevideo-${id}`), stream);
    },

    oncleanup: function () {
      removeRemoteFeed(id);
    },

    ondetached: function () {
      removeRemoteFeed(id);
    }
  });
}

// ✅ remote feed 제거
function removeRemoteFeed(id) {
  console.log(`🧹 remote feed 제거: ${id}`);
  $(`#remote-box-${id}`).remove();
  feeds = feeds.filter(f => f.rfid !== id);
}

// ✅ 전체 정리
function cleanupAllFeeds() {

	 if (isDestroying) return;
	  isDestroying = true; // 🔐 진입 플래그 설정

	  console.log("🧹 cleanupAllFeeds() 실행");
	
  // remote feed detach + 배열 초기화
   feeds.forEach((f, i) => {
    if (f) {
      try { f.detach(); } catch (e) {}
      feeds[i] = null;
    }
  });
  feeds = [];
  
  // 영상 DOM 제거
  $('#remoteContainer').empty();
  $('#local-box').remove();
  
  // 핸들 및 세션 초기화
  if (sfutest) sfutest.detach();
  sfutest = null;
  myid = null;
  mypvtid = null;
  selectedRoomId = null;
  displayName = null;
  
  // janus 세션 제거
  if (janus) {
    janus.destroy();
    janus = null;
  }
}

// 종료버튼 클릭시
document.getElementById("exitBtn").addEventListener("click", function () {
	if (janus) {
		janus.destroy(); // 내부적으로 cleanupAllFeeds 호출
	}
		navigate('main'); // navigate는 세션정리 없이 화면 전환만
});


</script>


</body>
</html>