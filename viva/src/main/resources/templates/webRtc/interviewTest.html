<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>화상 면접 SPA</title>

<style>
/* main-view, new-view, list-view는 각각 숨김처리 */
.view {
	display: none;
}

.view.active {
	display: block;
}

body {
	font-family: 'Arial', sans-serif;
	background-color: #f2f2f2;
	padding: 20px;
}

/* ================================== */
header, footer {
	background-color: #cfd8ff;
	padding: 10px 20px;
	text-align: center;
}

header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	font-weight: bold;
}

.logo {
	font-size: 1.2rem;
}

.login-link {
	font-size: 0.9rem;
}

main {
	background-color: #ffffff;
	min-height: 400px;
	display: flex;
	justify-content: center;
	align-items: center;
	padding: 40px 0;
}

.content-box {
	border: 1px solid #d0d0d0;
	border-radius: 6px;
	padding: 30px 50px;
	text-align: center;
}

.content-box h2 {
	margin-bottom: 30px;
	font-size: 1.4rem;
}

.button-group {
	display: flex;
	gap: 20px;
	justify-content: center;
}

.nav-button {
	width: 120px;
	height: 100px;
	background-color: #e0e0e0;
	border: none;
	border-radius: 6px;
	font-size: 1rem;
	font-weight: bold;
	cursor: pointer;
	transition: background-color 0.2s;
}

.nav-button:hover {
	background-color: #d6d6d6;
}

footer {
	font-weight: bold;
}

/* ================================== */
.room-list {
	display: flex;
	flex-wrap: wrap;
	gap: 20px;
}

.room-card {
	background-color: #fff;
	width: 300px;
	border-radius: 12px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	padding: 16px;
	position: relative;
}

.room-status-dot {
	width: 10px;
	height: 10px;
	border-radius: 50%;
	display: inline-block;
	margin-right: 8px;
}

.status-waiting {
	background-color: red;
}

.status-playing {
	background-color: green;
}

.status-ended {
	background-color: gray;
}

.room-title {
	font-size: 1.1rem;
	font-weight: bold;
	margin: 8px 0;
}

.room-info {
	color: #666;
	font-size: 0.9rem;
	margin-top: 4px;
}

.room-icon {
	position: absolute;
	bottom: 16px;
	right: 16px;
	font-size: 1.2rem;
}

.room-list a {
	text-decoration: none;
	color: inherit;
}

.room-list a:hover {
	transform: translateY(-4px);
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/*** 비디오 영역 css ***/
/* 🔷 전체 wrapper: 비디오 + 채팅 수평 배치 */
.video-chat-wrapper {
  display: flex;
  gap: 20px;
  height: 100%;
}

/* 🔷 비디오 그리드 영역 */
.video-grid {
  flex: 3;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* 🔷 채팅창 영역 */
.chat-panel {
  flex: 1;
  border: 1px solid #ccc;
  border-radius: 8px;
  background: #fff;
  display: flex;
  flex-direction: column;
  height: 600px; /* 원하는 높이 설정 */
}

/* 채팅창 내부 구성 */
.chat-title {
  font-weight: bold;
  padding: 10px;
  background-color: #cfd8ff;
  border-bottom: 1px solid #ccc;
  text-align: center;
}

.chat-messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  font-size: 0.9rem;
}

.chat-input-area {
  display: flex;
  border-top: 1px solid #ccc;
}

.chat-input-area input {
  flex: 1;
  padding: 8px;
  border: none;
  border-right: 1px solid #ccc;
}

.chat-input-area button {
  padding: 8px 12px;
  border: none;
  background-color: #607d8b;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

.chat-input-area button:hover {
  background-color: #455a64;
}

.label {
	font-size: 14px;
	background-color: #3498db;
	color: #fff;
	padding: 2px 6px;
	border-radius: 3px;
}

.hide {
	display: none;
}

.remote-grid {
	display: grid;
	grid-template-columns: repeat(2, 1fr); /* 2열 고정 */
	gap: 10px;
}

.remote-box {
	position: relative;
	border: 1px solid #ccc;
	padding: 5px;
	min-height: 150px;
}

.remote-box video {
  background-color: black;
  width: 100%;
  height: 240px; /* 또는 auto, fixed 등 */
  object-fit: cover;
}

.bitrate-controls {
	margin-left: 10px;
	display: inline-block;
	position: relative;
}

.dropdown-menu {
	list-style: none;
	position: absolute;
	background: #fff;
	border: 1px solid #aaa;
	margin: 0;
	padding: 0;
	display: none;
}

.dropdown-menu li {
	padding: 5px 10px;
}

.dropdown-menu li:hover {
	background-color: #f0f0f0;
}

#bitrateset:hover+.dropdown-menu, .dropdown-menu:hover {
	display: block;
}

.remote-box video {
  width: 100%;
  max-width: 480px;       /* 👈 원하는 너비 제한 */
  height: auto;
  aspect-ratio: 4 / 3;     /* 또는 16 / 9 등 비율 고정 */
  object-fit: cover;       /* contain or cover */
}

/* 상단 사용자 목록 바 */
.top-bar {
  display: flex;
  gap: 10px;
  padding: 10px 20px;
  background-color: #1e1e1e;
  color: white;
  overflow-x: auto;
}

.participant {
  background-color: #333;
  padding: 6px 12px;
  border-radius: 4px;
  min-width: 80px;
  text-align: center;
}

.participant.current {
  border: 2px solid #4fa7ff;
}


</style>
<!-- 외부 라이브러리 -->
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js}"></script>
<script
	th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.4.0/bootbox.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js}"></script>

<script th:src="@{https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js}"></script>
<script th:src="@{https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js}"></script>


<!-- 내부 라이브러리 -->
<script th:src="@{/js/webRtc/janus.js}"></script>
<link rel="stylesheet" th:href="@{/css/common.css}">
<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css}" />
<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css}" />


</head>
<body>
<!-- header -->
<div th:replace="fragments/header :: header"></div>

	<!-- [2] 방 생성 화면 -->
	<div id="new-view" class="view">
		<h2>면접 방 생성</h2>
		<script>
			console.log("[[${userId}]]");
		</script>
		<form id="createRoomForm">
			<label for="intrRoomTitle">방 제목:</label> 
			<input type="text" id="intrRoomTitle" name="intrRoomTitle" required />
			<input type="hidden" id="host_id" name="host_id" th:value="${userId}">
			<button type="submit">방생성</button>
		</form>
		<button onclick="navigate('main')">← 뒤로가기</button>
	</div>

	<!-- [3] 방 목록 화면 -->
	<div id="list-view" class="view active">
		<h2>면접 방 목록</h2>
		<input type="hidden" id="user_id" name="user_id" th:value="${userId}">
		<div id="roomList" class="room-list"></div>
		<button onclick="navigate('main')">← 뒤로가기</button>
	</div>

	<!-- [4] 통화방 화면 -->
	<div id="videoroom-view" class="view">
		 <!-- 🔵 상단 참가자 바 -->
		<div class="top-bar">
		    <div class="participant">user</div>
		    <div class="participant current">나</div>
		    <div class="participant">user</div>
		</div>

		<div class="video-chat-wrapper">
		    <!-- 🔵 비디오 그리드 -->
		    <div class="video-grid">
		    	<!-- 내 화면 포함 -->
				<div class="remote-grid" id="remoteContainer">
					<!-- 비디오 출력 영역 -->
				</div>
			</div>
			
			<!-- 🔵 채팅창 -->
		    <div class="chat-panel">
		      <div class="chat-title">채팅창</div>
		      <div class="chat-messages" id="chatMessages"></div>
		      <div class="chat-input-area">
		        <input type="text" id="chatInput" placeholder="내용 입력" />
		        <button id="sendChatBtn">전송</button>
		      </div>
		  	</div>
		</div>
	    <div style="margin-top: 20px;">
	    	<button id="startCamBtn">📷 캠 시작</button>
	    	<button id="exitBtn">종료</button>
	    </div>
	</div>

<script>
//✅ 전역 상태 변수
var version = 1.2;
var server = null;
server = "https://janus.jsflux.co.kr/janus";
var janus = null;
var sfutest = null;
var mypvtid = null;
var opaqueId = "videoroom-" + Janus.randomString(12);
var selectedRoomId = null;
var displayName = null;
var feeds = [];
var isDestroying = false; 		// 중복 detach 방지용 플래그
const audioContexts = {};  		// { [feedId]: { ctx, gainNode } }
var myUsername = null;
var myDataId = null;
const userId = "[[${userId}]]";
let hostId = null;
let isDataChannelReady = false;
let currentView = null;

document.addEventListener("DOMContentLoaded", () => {
	  // 'list-view'가 활성화된 경우 자동으로 방 목록 불러오기
	  const listView = document.getElementById("list-view");
	  if (listView && listView.classList.contains("active")) {
	  	loadRoomList();
	}
});

// navigate 처리 (화면 전환 시 정리 포함)
function navigate(view) {
	
	// 1️ 현재 뷰에서 나가기 전에 정리 작업
	if (currentView === 'videoroom' && view !== 'videoroom') {
	    leaveRoom();  // WebSocket + Janus 연결 정리
	}
	
	// 2 화면 전환
  	document.querySelectorAll('.view').forEach(div => div.classList.remove('active'));
  	document.getElementById(view + '-view').classList.add('active');
  
  	// 뷰 별 진입 처리
  	if (view === 'list') loadRoomList();
  	
  	if (view === 'videoroom'){
		initJanus(); // 방 입장 시 초기화
  	}
  
  	currentView = view;
}

// ✅ 방 생성
const createForm = document.getElementById("createRoomForm");
if (createForm) {
  createForm.addEventListener("submit", function(e) {
    e.preventDefault();
    const title = document.getElementById("intrRoomTitle").value;
	const host_id = document.getElementById("host_id").value;
	console.log("hostId : " + host_id);
    fetch("/api/meeting/roomcreate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
    	  intrRoomTitle: title,
    	  hostId: host_id
      })
    })
    .then(res => res.json())
    .then(data => {
      alert(`방 생성 완료: ${data.intrRoomTitle}`);
      
      const roomId = data.intrRoomId;
      const hostId = data.hostId;

   	  // ✅ Janus 세션 시작 → 방 생성 → 종료
      createRoomsOnJanus(roomId, hostId);
      
      navigate('list');
    });
  });
}

// 방 생성용 janus 세션 생성
function createRoomsOnJanus(roomId, hostId) {
	  Janus.init({
	    debug: "all",
	    callback: function () {
	      const janus = new Janus({
	        server: server, // Janus 서버 주소
	        success: function () {
	          // 1️⃣ 비디오룸 플러그인 attach
	          janus.attach({
	            plugin: "janus.plugin.videoroom",
	            success: function (videohandle) {
	              videohandle.send({
	                message: {
	                  request: "create",
	                  room: roomId,
	                  description: `Room for host ${hostId}`,
	                  publishers: 6,
	                  data: true
	                }
	              });

	              console.log("📹 Video room created");
	            },
	            error: function (err) {
	              console.error("Video plugin attach error", err);
	            }
	          });
	        },
	        error: function (err) {
	          console.error("Janus session error", err);
	        },
	        destroyed: function () {
	          console.log("Janus session destroyed");
	        }
	      });
	    }
	  });
}

// ✅ 방 목록
function loadRoomList() {
  fetch("/api/meeting/roomlist")
    .then(res => res.json())
    .then(data => {
      const listEl = document.getElementById("roomList");
      if (!listEl) return;
      listEl.innerHTML = "";

      data.forEach(room => {
        const statusClass = room.statusCd === 'waiting' ? 'status-waiting'
                          : room.statusCd === 'in_progress' ? 'status-playing'
                          : 'status-ended';

        const div = document.createElement("div");
        div.className = "room-card";
        div.innerHTML = `
          <div>
            <span class="room-status-dot ${statusClass}"></span>
            <span>${room.intrRoomId}</span>
          </div>
          <div class="room-title">${room.intrRoomTitle}</div>
          <div class="room-info">${room.hostId}님의 방</div>
          <div class="room-info">생성: ${formatDate(room.createdDt)}</div>
          <div class="room-icon">🔒 🔓</div>
        `;
        div.addEventListener("click", () => enterRoom(room.intrRoomId, room.hostId, userId));
        listEl.appendChild(div);
      });
    });
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleString("ko-KR", {
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit'
  });
}

//참가자 목록을 담는 전역 배열
let participants = [];

//참가자 목록 콘솔 출력 함수
function logParticipants() {
  console.log("📋 현재 참가자 목록:");
  participants.forEach(p => {
    console.log(`- ID: ${p.id}, Display: ${p.display}`);
  });
}

// ✅ 참가자 추가 함수
function addParticipant(id, display) {
  if (!participants.find(p => p.id === id)) {
    participants.push({ id, display });
    logParticipants();
  }
}

// ✅ 참가자 제거 함수
function removeParticipant(id) {
  participants = participants.filter(p => p.id !== id);
  logParticipants();
}

// ✅ 방 입장
function enterRoom(roomId, host, name) {
  selectedRoomId = roomId;
  displayName = name;
  hostId = host;
  
  console.log("선택된 방 번호 : " + selectedRoomId);
  console.log("선택된 방 hostId : " + hostId);
  console.log("입장 유저 Id : " + displayName);
  
  connectChat(selectedRoomId);		// 채팅방 연결

  
  // 🔻 기존 영상 DOM 초기화
  $('#remoteContainer').empty();
  $('#local-box').remove();
  
  navigate('videoroom');
}

// ✅ Janus 초기화
function initJanus() {
  if (!Janus.isWebrtcSupported()) {
    alert("WebRTC를 지원하지 않는 브라우저입니다.");
    return;
  }
  
  Janus.init({
    debug: "all",
    callback: createJanusSession
  });
}

// ✅ 세션 생성
function createJanusSession() {
  
	console.log("세션 생성 : createJanusSession 진입");
	
	if (janus !== null) {
	    janus.destroy();
	    janus = null;
	  }
	  feeds = [];
	
    janus = new Janus({
    server: server,
    success: function () {
      janus.attach({
        plugin: "janus.plugin.videoroom",
        opaqueId: opaqueId,
        success: function (pluginHandle) {
          sfutest = pluginHandle;
          sfutest.send({
            message: {
              request: "join",
              room: Number(selectedRoomId),
              ptype: "publisher",
              display: displayName
            }
          });
          
          console.log("세션 생성 : 성공");
          
        },

     	// ICE 상태 변경 로그
		iceState: function(state) {
			Janus.log("ICE state changed to " + state);
		},
		
		// 미디어 전송 상태 (audio/video) 로그
		mediaState: function(medium, on) {
			Janus.log("Janus " + (on ? "started" : "stopped") + " receiving our " + medium);
		},
		
		// webRTC 연결 상태
		webrtcState: function(on) {
			Janus.log("Janus says our WebRTC PeerConnection is " + (on ? "up" : "down") + " now");
			// 대역폭 조절 버튼영역 표시
			$('#bitrate').parent().parent().removeClass('hide').show();
			// 각 대역폭 메뉴 클릭 시 bitrate 설정 처리
			$('#bitrate a').click(function() {
				var id = $(this).attr("id");
				var bitrate = parseInt(id)*1000;	// kbps -> bps 변환
				if(bitrate === 0) {
					Janus.log("Not limiting bandwidth via REMB");
				} else {
					Janus.log("Capping bandwidth to " + bitrate + " via REMB");
				}
				// 버튼 UI 텍스트 업데이트 및 메뉴 닫기
				$('#bitrateset').html($(this).html() + '<span class="caret"></span>').parent().removeClass('open');
				// janus 서버에 bitrate 설정 요청
				sfutest.send({ message: { request: "configure", bitrate: bitrate }});
				return false;
			});
		},
        
        onmessage: function (msg, jsep) {
          
          console.log("참가한 방 번호: " + selectedRoomId);
          console.log("[DEBUG] onmessage 수신 msg:", msg);
          // 방 최초 참가시
          if (msg.videoroom === "joined") {
        	mypvtid = msg.private_id;
//              publishOwnFeed();
				publishOwnDummyFeed()
            if (msg.publishers) {
              msg.publishers.forEach(pub => {
                if (!feeds.find(f => f.rfid === pub.id)) {
                  newRemoteFeed(pub.id, pub.display);
                }
              });
            }
          }
          
          // 새로운 유저가 입장한 경우
          if (msg.videoroom === "event" && msg.publishers) {
        	  msg.publishers.forEach(pub => {
        	    if (!feeds.find(f => f.rfid === pub.id)) {
        	      newRemoteFeed(pub.id, pub.display);
        	    }
        	 });
          }

          // 다른 유저가 퇴장한 경우
          if (msg.videoroom === "event" && msg.unpublished) {
            const unpublished = msg.unpublished;
            if (unpublished === 'ok') {
              // 본인 퇴장
              console.log("현재 feeds 목록:", feeds.map(f => f.rfid));
              cleanupAllFeeds();
            } else {
              console.log("현재 feeds 목록:", feeds.map(f => f.rfid));
              console.log("퇴장 대상 ID:", msg.leaving || msg.unpublished);
              console.log(`🧹 publisher ${unpublished} 퇴장`);
              
              removeParticipant(unpublished);                   // 👈 참가자 제거
              removeRemoteFeed(unpublished);
              
            }
          }

          if (msg.videoroom === "event" && msg.leaving) {
            console.log(`🚪 publisher ${msg.leaving} 나감`);
            removeParticipant(msg.leaving);                // 👈 참가자 제거
            removeRemoteFeed(msg.leaving);
          }

          if (jsep) sfutest.handleRemoteJsep({ jsep });
        },

        onlocalstream: function (stream) {		// 내 출력화면
        	
        	console.log("onlocalstream 진입");
        	
        	const remoteId = 'local'; // 고정 ID
        	const videoElId = `remotevideo-${remoteId}`;
        	const boxElId = `remote-box-${remoteId}`;
        	const muteBtnId = `mute-btn-${remoteId}`;
        	const volumeSliderId = `volume-slider-${remoteId}`;
        	
        	// 내 화면 영역
        	if (!document.getElementById(boxElId)) {
        	    const localBox = `
        	      <div class="remote-box" id="${boxElId}">
        	        <span>내 화면</span>
        	        <video id="${videoElId}" autoplay muted playsinline></video>
        	        <div style="margin-top: 4px;">
        	          <button id="${muteBtnId}" style="cursor: pointer;">🔊</button>
        	          <input type="range" min="0" max="2" step="0.01" value="1"
        	            class="volume-slider" data-id="${remoteId}" id="${volumeSliderId}"
        	            style="width: 80%; margin-top: 4px;" />
        	        </div>

        	        <!-- 🔻 Bandwidth 설정 (optional) -->
        	        <div class="bitrate-controls">
        	          <button id="bitrateset">Bandwidth ▼</button>
        	          <ul id="bitrate" class="dropdown-menu">
        	            <li><a href="#" id="0">No limit</a></li>
        	            <li><a href="#" id="128">128kbps</a></li>
        	            <li><a href="#" id="256">256kbps</a></li>
        	            <li><a href="#" id="512">512kbps</a></li>
        	            <li><a href="#" id="1024">1mbps</a></li>
        	            <li><a href="#" id="1500">1.5mbps</a></li>
        	            <li><a href="#" id="2000">2mbps</a></li>
        	          </ul>
        	        </div>
        	      </div>`;
        	    $('#remoteContainer').append(localBox);
        	  }
          
        	const videoElement = document.getElementById(videoElId);
        	Janus.attachMediaStream(videoElement, stream);

        	// 음향 조절
        	  try {
        	    const audioCtx = new AudioContext();
        	    const source = audioCtx.createMediaStreamSource(stream);
        	    const gainNode = audioCtx.createGain();
        	    source.connect(gainNode).connect(audioCtx.destination);

        	    audioContexts[remoteId] = {
        	      ctx: audioCtx,
        	      gainNode: gainNode,
        	      muted: false
        	    };

        	    const slider = document.getElementById(volumeSliderId);
        	    const muteBtn = document.getElementById(muteBtnId);

        	    slider.addEventListener('input', e => {
        	      const value = parseFloat(e.target.value);
        	      const state = audioContexts[remoteId];
        	      if (!state) return;

        	      state.gainNode.gain.value = value;
        	      if (value === 0) {
        	        state.muted = true;
        	        muteBtn.textContent = '🔇';
        	      } else {
        	        state.muted = false;
        	        muteBtn.textContent = '🔊';
        	      }
        	    });

        	    muteBtn.addEventListener('click', () => {
        	      const state = audioContexts[remoteId];
        	      if (!state) return;

        	      const slider = document.getElementById(volumeSliderId);
        	      if (state.muted) {
        	        // 음소거 해제
        	        const restoreVolume = parseFloat(slider.value) || 1.0;
        	        state.gainNode.gain.value = restoreVolume;
        	        muteBtn.textContent = '🔊';
        	      } else {
        	        // 음소거
        	        state.gainNode.gain.value = 0.0;
        	        muteBtn.textContent = '🔇';
        	      }
        	      state.muted = !state.muted;
        	    });
        	  } catch (err) {
        	    console.warn("⚠️ local stream audio 제어 실패", err);
        	  }
        	
          // stream이 비어있는 경우에도 attachMediaStream 처리 (검은 화면 표시)
          Janus.attachMediaStream(document.getElementById('localvideo'), stream);
        },

        oncleanup: cleanupAllFeeds,
        ondetached: cleanupAllFeeds,
        error: function (err) {
          console.error("Janus 오류", err);
        }
      });	// end videoroom 플러그인
    },

    destroyed: cleanupAllFeeds
  });
}

// ✅ 내 영상 publish
function publishOwnFeed() {
  console.log("publishOwnFeed 정상 호출");
  sfutest.createOffer({
    media: { 
      audioRecv: false, videoRecv: false, 
      audioSend: true, videoSend: true
    },
    success: function (jsep) {
      sfutest.send({
        message: { request: "configure", audio: true, video: true },
        jsep
      });
      console.log("publishOwnFeed 성공");
    },
    error: async function (error) {
      console.warn("📛 내 stream publish 실패", error.message);

      try {
        // ⚠️ 캠/마이크 없음 → dummyStream 사용
        const dummyStream = getSilentDummyStream();

        // ⚠️ local-box는 onlocalstream에서만 생성 → 여기선 비디오 연결만
        const videoElem = document.getElementById('localvideo');
        if (videoElem) {
          videoElem.srcObject = dummyStream;
        } else {
          console.warn("⚠️ localvideo element가 없음. onlocalstream에서 처리 필요");
        }

        // Janus에 dummy stream attach 후 publish
        sfutest.createOffer({
          stream: dummyStream,
          media: {
            audioRecv: false,
            videoRecv: false,
            audioSend: true,
            videoSend: true
          },
          success: function (jsep) {
            sfutest.send({
              message: { request: "configure", audio: true, video: true },
              jsep
            });
          },
          error: function (err) {
            console.error("📛 dummyStream publish 실패", err);
          }
        });

      } catch (e) {
        console.error("❌ dummyStream 구성 실패", e);   
      }
    }
  });
}

// 입장시 더미 스트림 publish
function publishOwnDummyFeed() {
	  const dummyStream = getSilentDummyStream();

	  sfutest.createOffer({
	    stream: dummyStream,
	    media: {
	      audioRecv: false,
	      videoRecv: false,
	      audioSend: true,
	      videoSend: true
	    },
	    success: function (jsep) {
	      sfutest.send({
	        message: { request: "configure", audio: true, video: true },
	        jsep
	      });
	    },
	    error: function (err) {
	      console.error("📛 dummyStream publish 실패", err);
	    }
	  });
	}

// 캠없는 경우 더미 데이터
function getSilentDummyStream() {
	  const stream = new MediaStream();

	  // 🔇 dummy audio track
	  const audioCtx = new AudioContext();
	  const oscillator = audioCtx.createOscillator();
	  const dst = oscillator.connect(audioCtx.createMediaStreamDestination());
	  oscillator.start();
	  const audioTrack = dst.stream.getAudioTracks()[0];
	  stream.addTrack(audioTrack);

	  // 📷 dummy video track (검정 화면)
	  const canvas = Object.assign(document.createElement("canvas"), { width: 320, height: 240 });
	  const ctx = canvas.getContext("2d");
	  ctx.fillStyle = "black";
	  ctx.fillRect(0, 0, canvas.width, canvas.height);
	  const videoTrack = canvas.captureStream().getVideoTracks()[0];
	  stream.addTrack(videoTrack);

	  return stream;
	}

// ✅ remote feed 추가
function newRemoteFeed(id, display) {

  //이미 등록된 feed인지 확인 (중복 방지)
  if (feeds.find(f => f.rfid === id)) {
    console.warn(`⚠️ Feed ${id} already exists, skipping newRemoteFeed`);
    return;
  }
  
  //이미 DOM에 해당 ID의 video 박스가 존재하는 경우
  if (document.getElementById(`remote-box-${id}`)) {
    console.warn(`⚠️ remote-box-${id} already exists in DOM, skipping`);
    return;
  }
  
  janus.attach({
    plugin: "janus.plugin.videoroom",
    opaqueId,

    success: function (pluginHandle) {
      const remoteFeed = pluginHandle;
      remoteFeed.rfid = id;
      remoteFeed.rfdisplay = display;

      feeds.push(remoteFeed);

      remoteFeed.send({
        message: {
          request: "join",
          room: Number(selectedRoomId),
          ptype: "subscriber",
          feed: id,
          private_id: mypvtid
        }
      });
    },

    onmessage: function (msg, jsep) {
      if (jsep) {
        feeds.find(f => f.rfid === id)?.createAnswer({
          jsep,
          media: { audioSend: false, videoSend: false },
          success: function (jsep) {
            feeds.find(f => f.rfid === id)?.send({ message: { request: "start", room: Number(selectedRoomId) }, jsep });
          },
          error: function (err) {
            console.error("remote SDP 오류", err);
          }
        });
      }
    },

    onremotestream: function (stream) {
    	
    	const remoteId = id;
    	const videoElId = `remotevideo-${remoteId}`;
    	const boxElId = `remote-box-${remoteId}`;
    	const muteBtnId = `mute-btn-${remoteId}`;
    	const volumeSliderId = `volume-slider-${remoteId}`;
    	
    	if (document.getElementById(boxElId)) return;
      
    	// remote-box HTML 생성 및 삽입
      	const html = `
        	<div class="remote-box" id="${boxElId}">
	          	<span>${display}</span>
	          	<video id="${videoElId}" autoplay playsinline></video>
	          	<div style="margin-top: 4px;">
	            	<button id="${muteBtnId}" style="cursor: pointer;">🔊</button>
	          		<input type="range" min="0" max="2" step="0.01" value="1" 
	                	class="volume-slider" data-id="${remoteId}" style="width: 80%; margin-top: 4px;" />
	            </div>
        	</div>`;
      	$('#remoteContainer').append(html);
      	
      	// 비디오 스트림 연결
        const videoElement = document.getElementById(videoElId);
        Janus.attachMediaStream(videoElement, stream);

        // 오디오 컨텍스트 구성
        const audioCtx = new AudioContext();
        const source = audioCtx.createMediaStreamSource(stream);
        const gainNode = audioCtx.createGain();

        // 오디오 흐름: source -> gainNode -> 출력
        source.connect(gainNode).connect(audioCtx.destination);

        // 전역 저장소에 등록
        audioContexts[remoteId] = {
          ctx: audioCtx,
          gainNode: gainNode,
          muted: false  // 초기 상태: 음소거 아님
        };

     	// 볼륨 슬라이더 제어
        const slider = document.getElementById(volumeSliderId);
        slider.addEventListener('input', e => {
          const value = parseFloat(e.target.value);
          
          state.gainNode.gain.value = value;
          if (value === 0) {
            state.muted = true;
            muteBtn.textContent = '🔇';
          } else {
            state.muted = false;
            muteBtn.textContent = '🔊';
          }
        });
        
     	// 음소거 버튼 제어
        const muteBtn = document.getElementById(muteBtnId);
        muteBtn.addEventListener('click', () => {
          const state = audioContexts[remoteId];
          const slider = document.getElementById(volumeSliderId);
          if (!state || !slider) return;
          
          if (state.muted) {
        	// 음소거 해제
        	const restoreVolume = parseFloat(slider.value) || 1.0;
            state.gainNode.gain.value = restoreVolume;
            muteBtn.textContent = '🔊';
          } else {
        	// 음소거
            state.gainNode.gain.value = 0.0;
            muteBtn.textContent = '🔇';
          }
          state.muted = !state.muted;
        });
      	
    },

    oncleanup: function () {
      removeRemoteFeed(id);
    },

    ondetached: function () {
      removeRemoteFeed(id);
    }
  });
}

// ✅ remote feed 제거
function removeRemoteFeed(id) {
  console.log(`🧹 remote feed 제거: ${id}`);
  $(`#remote-box-${id}`).remove();
  if (audioContexts[id]) {
	audioContexts[id].ctx.close();
	delete audioContexts[id];
  }
  feeds = feeds.filter(f => f.rfid !== id);
}

// ✅ 전체 정리
function cleanupAllFeeds() {

	 if (isDestroying) return;
	  isDestroying = true; // 🔐 진입 플래그 설정

	  console.log("🧹 cleanupAllFeeds() 실행");
	
  // remote feed detach + 배열 초기화
   feeds.forEach((f, i) => {
    if (f) {
      try { f.detach(); } catch (e) {}
      feeds[i] = null;
    }
  });
  feeds = [];
  
  // 영상 DOM 제거
  $('#remoteContainer').empty();
  $('#local-box').remove();
  
  // Audio context 정리
  Object.values(audioContexts).forEach(state => state.ctx.close());
  Object.keys(audioContexts).forEach(k => delete audioContexts[k]);
  
  // 핸들 및 세션 초기화
  if (sfutest) sfutest.detach();
  sfutest = null;
  myid = null;
  mypvtid = null;
  myUsername = null;
  myDataId = null;
  selectedRoomId = null;
  displayName = null;
  
  // janus 세션 제거
  if (janus) {
    janus.destroy();
    janus = null;
  }
  
}

// 종료버튼 클릭시
document.getElementById("exitBtn").addEventListener("click", function () {
	navigate('main'); // navigate는 세션정리 없이 화면 전환만
});

// 캠 시작 버튼 클릭
document.getElementById("startCamBtn").addEventListener("click", function () {
	  publishOwnFeed();
});

// 내 캠 음소거
function toggleMute() {
	const muted = sfutest.isAudioMuted();
	if (muted) {
	    sfutest.unmuteAudio();
	    $('#mute').html("Mute");
	} else {
	    sfutest.muteAudio();
	    $('#mute').html("Unmute");
	}
}

// websocket 연결 및 구독
let stompClient = null;
let chatSubscription = null;		// 구독 객체 저장용 (나중에 unsubscribe 가능)

function connectChat(roomId) {
  if (stompClient && stompClient.connected) {
	  stompClient.disconnect(() => {
	    console.log("🔌 기존 WebSocket 연결 해제 완료");
	  });
  }
	
  const socket = new SockJS("http://52.78.112.81:8080/ws-chat");
  stompClient = Stomp.over(socket);

  stompClient.connect({}, function () {
    console.log("✅ 채팅 연결 성공");
    
    // 구독
    stompClient.subscribe(`/topic/chat/${roomId}`, function (messageOutput) {
      const msg = JSON.parse(messageOutput.body);
      appendChatMessage(msg.sender, msg.message);
    });
	sendMessage(displayName + "님이 입장하셨습니다.");
  });
  
}

// websocket 연결 종료
function disconnectChat() {
	if (stompClient && stompClient.connected) {
	  stompClient.disconnect(() => {
	    console.log("🛑 WebSocket 연결 종료됨");
	  });
	}
}

function leaveRoom() {
	// 1. 채팅 퇴장 메시지 전송
	if (stompClient && stompClient.connected) {
    	sendMessage(displayName + "님이 퇴장하셨습니다.");
  	}
	
	// 2. WebSocket 연결 해제
	if (stompClient) {
		disconnectChat();
		stompClient = null;
	
		// 채팅창 초기화
		const chatBox = document.getElementById("chatMessages");
		if (chatBox) chatBox.innerHTML = "";
		
	}

	// 3. Janus 연결 해제
	if (janus && !isDestroying) {
	    isDestroying = true;
	    janus.destroy({
	      	success: () => {
	        	console.log("🧹 Janus 세션 종료 완료");
	        	cleanupAllFeeds();
		        janus = null;
		        isDestroying = false;
	    	}
	  	});
	}
	
	// 4. 전역 상태 초기화
	selectedRoomId = null;
	displayName = null;
}

// 메세지 전송
function sendMessage(message) {
	const content = message;

	stompClient.send("/app/chat.send", {}, JSON.stringify({
		roomId: selectedRoomId,
		sender: displayName,
	    message: content
	}));

}

// 채팅 메세지 DOM 추가
function appendChatMessage(sender, msg) {
  const chatBox = document.getElementById("chatMessages");
  const p = document.createElement("p");
  
  const safeSender = escapeHtml(sender);
  const safeMsg = escapeHtml(msg);
  
  p.textContent = `[${sender}] ${msg}`;
  chatBox.appendChild(p);
  chatBox.scrollTop = chatBox.scrollHeight;
}

//HTML 이스케이프 처리 함수 (XSS 방지용)
function escapeHtml(str) {
  return str.replace(/[&<>"']/g, function (match) {
    return {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[match];
  });
}

// 이벤트 바인딩
const input = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendChatBtn");

document.getElementById("sendChatBtn").addEventListener("click", () => {
  const message = input.value.trim();
  if (message !== "") {
    sendMessage(message);
    input.value = "";
  }
});

//Enter 키 입력 이벤트
input.addEventListener("keypress", function (e) {
  if (e.key === "Enter" && !e.shiftKey) {		// 엔터키 감지 && Shift+Enter 줄바꿈 허용
    e.preventDefault(); // 줄바꿈 방지
    sendBtn.click();    // 전송 버튼 클릭과 동일한 효과
  }
});

</script>


</body>
</html>