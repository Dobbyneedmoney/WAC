<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>화상 면접 SPA</title>

<style>
/* main-view, new-view, list-view는 각각 숨김처리 */
.view {
	display: none;
}

.view.active {
	display: block;
}

body {
	font-family: 'Arial', sans-serif;
	background-color: #f2f2f2;
	padding: 20px;
}

/* ================================== */
header, footer {
	background-color: #cfd8ff;
	padding: 10px 20px;
	text-align: center;
}

header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	font-weight: bold;
}

.logo {
	font-size: 1.2rem;
}

.login-link {
	font-size: 0.9rem;
}

main {
	background-color: #ffffff;
	min-height: 400px;
	display: flex;
	justify-content: center;
	align-items: center;
	padding: 40px 0;
}

.content-box {
	border: 1px solid #d0d0d0;
	border-radius: 6px;
	padding: 30px 50px;
	text-align: center;
}

.content-box h2 {
	margin-bottom: 30px;
	font-size: 1.4rem;
}

.button-group {
	display: flex;
	gap: 20px;
	justify-content: center;
}

.nav-button {
	width: 120px;
	height: 100px;
	background-color: #e0e0e0;
	border: none;
	border-radius: 6px;
	font-size: 1rem;
	font-weight: bold;
	cursor: pointer;
	transition: background-color 0.2s;
}

.nav-button:hover {
	background-color: #d6d6d6;
}

footer {
	font-weight: bold;
}

/* ================================== */
.room-list {
	display: flex;
	flex-wrap: wrap;
	gap: 20px;
}

.room-card {
	background-color: #fff;
	width: 300px;
	border-radius: 12px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	padding: 16px;
	position: relative;
}

.room-status-dot {
	width: 10px;
	height: 10px;
	border-radius: 50%;
	display: inline-block;
	margin-right: 8px;
}

.status-waiting {
	background-color: red;
}

.status-playing {
	background-color: green;
}

.status-ended {
	background-color: gray;
}

.room-title {
	font-size: 1.1rem;
	font-weight: bold;
	margin: 8px 0;
}

.room-info {
	color: #666;
	font-size: 0.9rem;
	margin-top: 4px;
}

.room-icon {
	position: absolute;
	bottom: 16px;
	right: 16px;
	font-size: 1.2rem;
}

.room-list a {
	text-decoration: none;
	color: inherit;
}

.room-list a:hover {
	transform: translateY(-4px);
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/*** 비디오 영역 css ***/
#videoroom-view {
	padding: 20px;
}

#local-area, #remote-area {
	margin-bottom: 20px;
}

.label {
	font-size: 14px;
	background-color: #3498db;
	color: #fff;
	padding: 2px 6px;
	border-radius: 3px;
}

.hide {
	display: none;
}

.remote-grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
	gap: 10px;
}

.remote-box {
	position: relative;
	border: 1px solid #ccc;
	padding: 5px;
	min-height: 150px;
}

.remote-box video {
  background-color: black;
  width: 100%;
  height: 240px; /* 또는 auto, fixed 등 */
  object-fit: cover;
}

.bitrate-controls {
	margin-left: 10px;
	display: inline-block;
	position: relative;
}

.dropdown-menu {
	list-style: none;
	position: absolute;
	background: #fff;
	border: 1px solid #aaa;
	margin: 0;
	padding: 0;
	display: none;
}

.dropdown-menu li {
	padding: 5px 10px;
}

.dropdown-menu li:hover {
	background-color: #f0f0f0;
}

#bitrateset:hover+.dropdown-menu, .dropdown-menu:hover {
	display: block;
}

.remote-box video {
  width: 100%;
  max-width: 480px;       /* 👈 원하는 너비 제한 */
  height: auto;
  aspect-ratio: 4 / 3;     /* 또는 16 / 9 등 비율 고정 */
  object-fit: cover;       /* contain or cover */
}

</style>
<!-- 외부 라이브러리 -->
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js}"></script>
<script
	th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.4.0/bootbox.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js}"></script>
<script
	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js}"></script>



<!-- 내부 라이브러리 -->
<script th:src="@{/js/webRtc/janus.js}"></script>

<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css}" />
<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css}" />


</head>
<body>

	<!-- [1] 메인 화면 -->
	<div id="main-view" class="view active">
		<header>
			<div class="logo">로고</div>
			<div class="login-link">
				<a href="/login">로그인</a>
			</div>
		</header>
		<main>
			<div class="content-box">
				<h2>면접 메인</h2>
				<div class="button-group">
					<button class="nav-button" onclick="navigate('new')">New
						Meeting</button>
					<button class="nav-button" onclick="navigate('list')">Join</button>
				</div>
			</div>
		</main>
		<footer>푸터</footer>
	</div>

	<!-- [2] 방 생성 화면 -->
	<div id="new-view" class="view">
		<h2>면접 방 생성</h2>
		<form id="createRoomForm">
			<label for="intrRoomTitle">방 제목:</label> <input type="text"
				id="intrRoomTitle" name="intrRoomTitle" required />
			<button type="submit">방생성</button>
		</form>
		<button onclick="navigate('main')">← 뒤로가기</button>
	</div>

	<!-- [3] 방 목록 화면 -->
	<div id="list-view" class="view">
		<h2>면접 방 목록</h2>
		<div id="roomList" class="room-list"></div>
		<button onclick="navigate('main')">← 뒤로가기</button>
	</div>

	<!-- [4] 통화방 화면 -->
	<div id="videoroom-view" class="view">
		<h2>화상 통화</h2>

		<div class="remote-grid" id="remoteContainer"></div>


		<!-- 로컬 비디오 -->
<!-- 		<section id="local-area"> -->
<!-- 			<h3> -->
<!-- 				내 화면 <span id="publisher" class="label hide"></span> <span -->
<!-- 					class="bitrate-controls hide"> -->
<!-- 					<button id="bitrateset">Bandwidth ▼</button> -->
<!-- 					<ul id="bitrate" class="dropdown-menu"> -->
<!-- 						<li><a href="#" id="0">No limit</a></li> -->
<!-- 						<li><a href="#" id="128">128kbps</a></li> -->
<!-- 						<li><a href="#" id="256">256kbps</a></li> -->
<!-- 						<li><a href="#" id="512">512kbps</a></li> -->
<!-- 						<li><a href="#" id="1024">1mbps</a></li> -->
<!-- 						<li><a href="#" id="1500">1.5mbps</a></li> -->
<!-- 						<li><a href="#" id="2000">2mbps</a></li> -->
<!-- 					</ul> -->
<!-- 				</span> -->
<!-- 			</h3> -->
<!-- 			<div id="videolocal"> -->
<!-- 				<video id="myVideo" autoplay muted playsinline width="320" -->
<!-- 					height="240" border="1"></video> -->
<!-- 			</div> -->
<!-- 		</section> -->
		<!-- 원격 비디오 -->
<!-- 		<section id="remote-area"> -->
<!-- 			<h3>상대 화면</h3> -->
<!-- 			<div class="remote-grid"> -->
<!-- 				<div class="remote-box" id="videoremote1"> -->
<!-- 					<span id="remote1" class="label hide"></span> -->
<!-- 				</div> -->
<!-- 				<div class="remote-box" id="videoremote2"> -->
<!-- 					<span id="remote2" class="label hide"></span> -->
<!-- 				</div> -->
<!-- 				<div class="remote-box" id="videoremote3"> -->
<!-- 					<span id="remote3" class="label hide"></span> -->
<!-- 				</div> -->
<!-- 				<div class="remote-box" id="videoremote4"> -->
<!-- 					<span id="remote4" class="label hide"></span> -->
<!-- 				</div> -->
<!-- 				<div class="remote-box" id="videoremote5"> -->
<!-- 					<span id="remote5" class="label hide"></span> -->
<!-- 				</div> -->
<!-- 			</div> -->
<!-- 		</section> -->

		<button onclick="navigate('main')">종료</button>
	</div>


	<script>
//video-room-view에 진입 시 초기화
function navigate(view) {
    document.querySelectorAll('.view').forEach(div => div.classList.remove('active'));
    document.getElementById(view + '-view').classList.add('active');

    if (view === 'list') loadRoomList();
    if (view === 'videoroom'){
    	initJanus(); // 화상통화 화면 진입 시 초기화
    }else if (janus) {
    	// ✅ 방 나가기 시 전체 정리
        if (janus) {
            cleanupAllFeeds();       // remote feed + timer 제거
            janus.destroy();         // Janus 세션 종료
            janus = null;
            sfutest = null;
            mypvtid = null;
            selectedRoomId = null;
            displayName = null;
        }
    }
}

function cleanupAllFeeds() {
    // remote feeds 정리
    for (let i = 1; i < feeds.length; i++) {
        if (feeds[i]) {
            try {
                feeds[i].detach();
            } catch (e) {
                console.warn(`feed #${i} detach 실패`, e);
            }
            feeds[i] = null;
        }
    }

    // 비트레이트 타이머 제거
    for (let key in bitrateTimer) {
        if (bitrateTimer[key]) {
            clearInterval(bitrateTimer[key]);
            bitrateTimer[key] = null;
        }
    }

    // 원격 비디오 DOM 제거
    $('#remoteContainer').empty();

    // 로컬 비디오 정리
    $('#videolocal').empty();
    $('#publish').show();
}

//방 생성
document.getElementById("createRoomForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const title = document.getElementById("intrRoomTitle").value;

    fetch("/api/meeting/roomcreate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ intrRoomTitle: title })
    })
    .then(res => res.json())
    .then(data => {
        alert(`방 생성 완료: ${data.intrRoomTitle}`);
        navigate('list');
    });
});

// 방 목록 불러오기
function loadRoomList() {
    fetch("/api/meeting/roomlist")
        .then(res => res.json())
        .then(data => {
            const listEl = document.getElementById("roomList");
            listEl.innerHTML = ""; // 초기화

            data.forEach(room => {
                const statusClass = room.statusCd === 'waiting' ? 'status-waiting'
                                   : room.statusCd === 'in_progress' ? 'status-playing'
                                   : 'status-ended';

                const div = document.createElement("div");
                div.className = "room-card";

                div.innerHTML = `
                  <div>
                    <span class="room-status-dot ${statusClass}"></span>
                    <span>${room.intrRoomId}</span>
                  </div>
                  <div class="room-title">${room.intrRoomTitle}</div>
                  <div class="room-info">${room.hostId}님의 방</div>
                  <div class="room-info">생성: ${formatDate(room.createdDt)}</div>
                  <div class="room-icon">🔒 🔓</div>
                `;

                // 이벤트 등록
                div.addEventListener("click", () => enterRoom(room.intrRoomId, room.hostId));

//                 const html = `
//                     <div class="room-card" onclick="enterRoom(${room.intrRoomId}, '${room.hostId}')">
//                         <div>
//                             <span class="room-status-dot ${statusClass}"></span>
//                             <span>${room.intrRoomId}</span>
//                         </div>
//                         <div class="room-title">${room.intrRoomTitle}</div>
//                         <div class="room-info">${room.hostId}님의 방</div>
//                         <div class="room-info">생성: ${formatDate(room.createdDt)}</div>
//                         <div class="room-icon">🔒 🔓</div>
//                     </div>
//                 `;
                listEl.appendChild(div);
            });
        });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString("ko-KR", {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
    });
}

// 방 입장
function enterRoom(roomId, hostId) {
	selectedRoomId = roomId; // 전역 또는 상태 저장
	displayName = hostId;
    navigate('videoroom');   // SPA 방식의 화면 전환
}

// 브라우저 WebRTC 지원 확인 및 janus 초기화
function initJanus() {
    if (!Janus.isWebrtcSupported()) {
        alert("WebRTC를 지원하지 않는 브라우저입니다.");
        return;
    }

    Janus.init({
        debug: "all",
        callback: createJanusSession		// 초기화 후 세션 생성
    });
}

var version = 1.2;
var server = null;
server = "https://janus.jsflux.co.kr/janus";

let janus = null;
let sfutest = null;
let opaqueId = "videoroom-" + Janus.randomString(12);
let mypvtid = null;

var feeds = [];
var bitrateTimer = [];

var doSimulcast = (getQueryStringValue("simulcast") === "yes" || getQueryStringValue("simulcast") === "true");
var doSimulcast2 = (getQueryStringValue("simulcast2") === "yes" || getQueryStringValue("simulcast2") === "true");
var subscriber_mode = (getQueryStringValue("subscriber-mode") === "yes" || getQueryStringValue("subscriber-mode") === "true");

//Helper to parse query string
function getQueryStringValue(name) {
	name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
	var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		results = regex.exec(location.search);
	return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

// janus 세션 생성
function createJanusSession() {
    janus = new Janus({
        server: server,

        success: function () {
            janus.attach({
                plugin: "janus.plugin.videoroom",
                opaqueId: opaqueId,					// 세션 식별용

                // 플러그인 연결 성공 시
                success: function (pluginHandle) {
                    sfutest = pluginHandle;

                    // 방 참여 요청
                    const joinRequest = {
                        request: "join",
                        room: selectedRoomId,		// 선택된 방 id
                        ptype: "publisher",
                        display: displayName
                    };
                    sfutest.send({ message: joinRequest });
                },
				
                // 에러시
                error: function (error) {
                    console.error("플러그인 attach 실패", error);
                },

                consentDialog: function (on) {
                    Janus.debug("Consent dialog should be " + (on ? "on" : "off") + " now");
                    function publishOwnFeed(useAudio) {
                        sfutest.createOffer({
                            media: {
                                audioRecv: false, videoRecv: false,
                                audioSend: useAudio, videoSend: true
                            },
                            success: function (jsep) {
                                const publish = {
                                    request: "configure",
                                    audio: useAudio,
                                    video: true
                                };
                                sfutest.send({ message: publish, jsep: jsep });
                            },
                            error: function (error) {
                                console.error("미디어 publish 오류", error);
                            }
                        });
                    }

                },

                mediaState: function (medium, on) {
                	Janus.log("Janus " + (on ? "started" : "stopped") + " receiving our " + medium);
                },

                webrtcState: function (on) {
                    Janus.log("WebRTC 연결 상태:", on ? "연결됨" : "끊김");
                },

                onmessage: function (msg, jsep) {
                    if (msg.videoroom === "joined") {
                        mypvtid = msg.private_id;
                        publishOwnFeed(true);
                    }
                    if (msg["publishers"]) {	// 기존 참가자 구독처리
                    	const list = msg["publishers"];
                    	list.forEach(p => {
                    	newRemoteFeed(p.id, p.display, p.audio_codec, p.video_codec);
                    	});
                    }
                    if (jsep) {
                        sfutest.handleRemoteJsep({ jsep: jsep });
                    }
                },

                onlocalstream: function (stream) {
                    Janus.attachMediaStream(document.getElementById("myVideo"), stream);
                }
            });
        },

        error: function (error) {
            console.error("Janus 세션 생성 실패", error);
        },

        destroyed: function () {
            console.log("Janus 세션 종료됨");
        }
    });
}

function publishOwnFeed(useAudio) {
    sfutest.createOffer({
        media: {
            audioRecv: false, videoRecv: false,
            audioSend: useAudio, videoSend: true		// 캠/마이크 없을때 테스트하기 위해 임시로 false처리
            										// 기존 값 useAudio, true
        },
        success: function (jsep) {
            const publish = {
                request: "configure",
                audio: useAudio,
                video: true
            };
            sfutest.send({ message: publish, jsep: jsep });
        },
        error: function (error) {
            console.error("미디어 publish 오류", error);
        }
    });
}

//[jsflux] 새로운 유저 들어왔을때
function newRemoteFeed(id, display, audio, video) {
	// A new feed has been published, create a new plugin handle and attach to it as a subscriber
	var remoteFeed = null;
	janus.attach(
		{
			plugin: "janus.plugin.videoroom",
			opaqueId: opaqueId,
			success: function(pluginHandle) {
				remoteFeed = pluginHandle;
				remoteFeed.simulcastStarted = false;
				Janus.log("Plugin attached! (" + remoteFeed.getPlugin() + ", id=" + remoteFeed.getId() + ")");
				Janus.log("  -- This is a subscriber");
				// We wait for the plugin to send us an offer
				var subscribe = {
					request: "join",
					room: selectedRoomId,
					ptype: "subscriber",
					feed: id,
					private_id: mypvtid
				};
				// In case you don't want to receive audio, video or data, even if the
				// publisher is sending them, set the 'offer_audio', 'offer_video' or
				// 'offer_data' properties to false (they're true by default), e.g.:
				// 		subscribe["offer_video"] = false;
				// For example, if the publisher is VP8 and this is Safari, let's avoid video
				if(Janus.webRTCAdapter.browserDetails.browser === "safari" &&
						(video === "vp9" || (video === "vp8" && !Janus.safariVp8))) {
					if(video)
						video = video.toUpperCase()
					toastr.warning("Publisher is using " + video + ", but Safari doesn't support it: disabling video");
					subscribe["offer_video"] = false;
				}
				remoteFeed.videoCodec = video;
				remoteFeed.send({ message: subscribe });
			},
			error: function(error) {
				Janus.error("  -- Error attaching plugin...", error);
				bootbox.alert("Error attaching plugin... " + error);
			},
			onmessage: function(msg, jsep) {
				Janus.debug(" ::: Got a message (subscriber) :::", msg);
				var event = msg["videoroom"];
				Janus.debug("Event: " + event);
				if(msg["error"]) {
					bootbox.alert(msg["error"]);
				} else if(event) {
					if(event === "attached") {
						// Subscriber created and attached
						for(var i=1;i<6;i++) {
							if(!feeds[i]) {
								feeds[i] = remoteFeed;
								remoteFeed.rfindex = i;
								break;
							}
						}
						remoteFeed.rfid = msg["id"];
						remoteFeed.rfdisplay = msg["display"];
						if(!remoteFeed.spinner) {
							var target = document.getElementById('videoremote'+remoteFeed.rfindex);
							remoteFeed.spinner = new Spinner({top:100}).spin(target);
						} else {
							remoteFeed.spinner.spin();
						}
						Janus.log("Successfully attached to feed " + remoteFeed.rfid + " (" + remoteFeed.rfdisplay + ") in room " + msg["room"]);
						$('#remote'+remoteFeed.rfindex).removeClass('hide').html(remoteFeed.rfdisplay).show();
					} else if(event === "event") {
						// Check if we got a simulcast-related event from this publisher
						var substream = msg["substream"];
						var temporal = msg["temporal"];
						if((substream !== null && substream !== undefined) || (temporal !== null && temporal !== undefined)) {
							if(!remoteFeed.simulcastStarted) {
								remoteFeed.simulcastStarted = true;
								// Add some new buttons
								addSimulcastButtons(remoteFeed.rfindex, remoteFeed.videoCodec === "vp8" || remoteFeed.videoCodec === "h264");
							}
							// We just received notice that there's been a switch, update the buttons
							updateSimulcastButtons(remoteFeed.rfindex, substream, temporal);
						}
					} else {
						// What has just happened?
					}
				}
				if(jsep) {
					Janus.debug("Handling SDP as well...", jsep);
					// Answer and attach
					remoteFeed.createAnswer(
						{
							jsep: jsep,
							// Add data:true here if you want to subscribe to datachannels as well
							// (obviously only works if the publisher offered them in the first place)
							media: { audioSend: false, videoSend: false },	// We want recvonly audio/video
							success: function(jsep) {
								Janus.debug("Got SDP!", jsep);
								var body = { request: "start", room: selectedRoomId };
								remoteFeed.send({ message: body, jsep: jsep });
							},
							error: function(error) {
								Janus.error("WebRTC error:", error);
								bootbox.alert("WebRTC error... " + error.message);
							}
						});
				}
			},
			iceState: function(state) {
				Janus.log("ICE state of this WebRTC PeerConnection (feed #" + remoteFeed.rfindex + ") changed to " + state);
			},
			webrtcState: function(on) {
				Janus.log("Janus says this WebRTC PeerConnection (feed #" + remoteFeed.rfindex + ") is " + (on ? "up" : "down") + " now");
			},
			onlocalstream: function(stream) {
				// The subscriber stream is recvonly, we don't expect anything here
			},
			onremotestream: function(stream) {
				Janus.debug("Remote feed #" + remoteFeed.rfindex + ", stream:", stream);
				const rawId = remoteFeed.rfid || remoteFeed.getId();
				const id = `rf${rawId}`;
				const display = remoteFeed.rfdisplay || `user-${id}`;

				// 이미 있는 경우 제거 후 재생성 (중복 방지)
// 				$(`#remote-box-${id}`).remove();
				
				// 비디오 영역 동적 생성
				const remoteBox = $('<div>', {
				  class: 'remote-box',
				  id: `remote-box-${id}`,
				  style: 'position: relative;'
				});
				
				remoteBox.append(`<span class="label" id="label-${id}">${display}</span>`);
				remoteBox.append(`<video id="remotevideo-${id}" autoplay playsinline width="100%" height="100%" class="rounded centered relative hide"></video>`);
				remoteBox.append(`<span class="label label-primary hide" id="curres-${id}" style="position: absolute; bottom: 0px; left: 0px; margin: 5px;"></span>`);
				remoteBox.append(`<span class="label label-info hide" id="curbitrate-${id}" style="position: absolute; bottom: 0px; right: 0px; margin: 5px;"></span>`);
				
				const audioControls = $(
					'<div class="audio-controls" style="margin-top: 6px;">' +
					'<label for="volume-' + id + '">&#128266;</label>' +
					'<input type="range" id="volume-' + id + '" min="0" max="1" step="0.01" value="1" style="width: 100px;" />' +
					'<br />' +
					'<label for="sink-' + id + '">&#127911;</label>' +
					'<select id="sink-' + id + '"><option value="">기본 출력</option></select>' +
					'</div>'
				);
				
// 				const audioControls = $(`
// 				  <div class="audio-controls" style="margin-top: 6px;">
// 				  	<label for="volume-${id}">&#128266;</label>
// 				    <input type="range" id="volume-${id}" min="0" max="1" step="0.01" value="1" style="width: 100px;" />
// 				    <br />
// 				    <label for="sink-${id}">&#127911;</label>
// 				    <select id="sink-${id}"><option value="">기본 출력</option></select>
// 				  </div>
// 				`);
				remoteBox.append(audioControls);
				
				$('#remoteContainer').append(remoteBox);
				
				// 🔊 볼륨 조절
				document.getElementById(`volume-${id}`).addEventListener('input', e => {
					const vol = parseFloat(e.target.value);
					const vid = document.getElementById(`remotevideo-${id}`);
					if (vid) vid.volume = vol;
				});

				// 🎧 오디오 출력 장치 선택
				navigator.mediaDevices.enumerateDevices().then(devices => {
				    const outputs = devices.filter(d => d.kind === 'audiooutput');
				    const select = document.getElementById(`sink-${id}`);
				    outputs.forEach(device => {
				    	const opt = document.createElement('option');
				    	opt.value = device.deviceId;
				    	opt.textContent = device.label || device.deviceId;
				    	select.appendChild(opt);
				    });
				});
				
				document.getElementById(`sink-${id}`).addEventListener('change', function(e) {
				    const sinkId = e.target.value;
				    const video = document.getElementById(`remotevideo-${id}`);
				    if (!video.setSinkId) {
				      alert("이 브라우저는 setSinkId를 지원하지 않습니다.");
				      return;
				    }
				    video.setSinkId(sinkId).then(() => {
				    	console.log(`🔈 [${id}] 출력 장치 설정 완료: ${sinkId}`);
					}).catch(err => {
					   console.error("setSinkId 오류:", err);
					});
				});
				
				// 🎥 영상 연결
				const videoEl = document.getElementById(`remotevideo-${id}`);
				console.log("현재 여기");
				Janus.attachMediaStream(videoEl, stream);
				videoEl.classList.remove('hide');     // 👈 반드시 필요
				videoEl.style.display = 'block';      // 👈 추가적으로 명시

				// 🎯 해상도/비트레이트 추적
				$(videoEl).on("playing", function () {
				    const w = this.videoWidth;
				    const h = this.videoHeight;
				    $(`#curres-${id}`).removeClass('hide').text(`${w}x${h}`);
				});

				if (!bitrateTimer[id]) {
				    bitrateTimer[id] = setInterval(() => {
				    	const bitrate = remoteFeed.getBitrate();
				    	const w = videoEl.videoWidth;
				    	const h = videoEl.videoHeight;
				    	$(`#curbitrate-${id}`).removeClass('hide').text(bitrate);
				      	if (w && h) $(`#curres-${id}`).removeClass('hide').text(`${w}x${h}`);
					}, 1000);
				}
				
				const videoTracks = stream.getVideoTracks();
				console.log("🎥 videoTracks", videoTracks);
				if (!videoTracks || videoTracks.length === 0) {
					  // 비디오 트랙이 없으면 검은 배경의 placeholder만 유지
					  const videoEl = document.getElementById(`remotevideo-${id}`);
					  $(videoEl)
					    .removeClass('hide')
					    .css({
					      backgroundColor: 'black',
					      display: 'block'
					    });

					  // 플레이 이벤트 무시 처리
					  $(videoEl).off('playing');
				}


// 				var addButtons = false;
// 				if($('#remotevideo'+remoteFeed.rfindex).length === 0) {
// 					addButtons = true;
					
					
// 			        // 볼륨 조절 이벤트 바인딩
// 			        document.getElementById(`volume-${remoteFeed.rfindex}`).addEventListener('input', function(e) {
// 			            const vol = parseFloat(e.target.value);
// 			            const video = document.getElementById(`remotevideo${remoteFeed.rfindex}`);
// 			            if (video) video.volume = vol;
// 			        });
					
// 			        // 오디오 출력 장치 목록 채우기
// 			        navigator.mediaDevices.enumerateDevices().then(devices => {
// 			            const outputs = devices.filter(d => d.kind === 'audiooutput');
// 			            const select = document.getElementById(`sink-${remoteFeed.rfindex}`);
// 			            outputs.forEach(d => {
// 			                const option = document.createElement('option');
// 			                option.value = d.deviceId;
// 			                option.textContent = d.label || d.deviceId;
// 			                select.appendChild(option);
// 			            });
// 			        });

// 			        // 오디오 출력 장치 선택 이벤트 바인딩
// 			        document.getElementById(`sink-${remoteFeed.rfindex}`).addEventListener('change', function(e) {
// 			            const sinkId = e.target.value;
// 			            const videoEl = document.getElementById(`remotevideo${remoteFeed.rfindex}`);
// 			            if (!videoEl.setSinkId) {
// 			                alert("이 브라우저는 setSinkId를 지원하지 않습니다.");
// 			                return;
// 			            }
// 			            videoEl.setSinkId(sinkId).then(() => {
// 			                console.log(`Feed #${remoteFeed.rfindex}의 오디오 출력 장치가 ${sinkId || "기본"}로 설정됨`);
// 			            }).catch(err => {
// 			                console.error("setSinkId 오류:", err);
// 			            });
// 			        });
			        
// 					// 영상 준비 이벤트
// 					$("#remotevideo"+remoteFeed.rfindex).bind("playing", function () {
// 						if(remoteFeed.spinner)
// 							remoteFeed.spinner.stop();
// 						remoteFeed.spinner = null;
// 						$('#waitingvideo'+remoteFeed.rfindex).remove();
// 						if(this.videoWidth)
// 							$('#remotevideo'+remoteFeed.rfindex).removeClass('hide').show();
// 						var width = this.videoWidth;
// 						var height = this.videoHeight;
// 						$('#curres'+remoteFeed.rfindex).removeClass('hide').text(width+'x'+height).show();
// 						if(Janus.webRTCAdapter.browserDetails.browser === "firefox") {
// 							// Firefox Stable has a bug: width and height are not immediately available after a playing
// 							setTimeout(function() {
// 								var width = $("#remotevideo"+remoteFeed.rfindex).get(0).videoWidth;
// 								var height = $("#remotevideo"+remoteFeed.rfindex).get(0).videoHeight;
// 								$('#curres'+remoteFeed.rfindex).removeClass('hide').text(width+'x'+height).show();
// 							}, 2000);
// 						}
// 					});
// 				}
				
// 				// 스트림 연결
// 				Janus.attachMediaStream($('#remotevideo'+remoteFeed.rfindex).get(0), stream);
				
// 				// 비디오 트랙 없을 경우
// 				var videoTracks = stream.getVideoTracks();
// 				if(!videoTracks || videoTracks.length === 0) {
// 					// No remote video
// 					$('#remotevideo'+remoteFeed.rfindex).hide();
// 					if($('#videoremote'+remoteFeed.rfindex + ' .no-video-container').length === 0) {
// 						$('#videoremote'+remoteFeed.rfindex).append(
// 							'<div class="no-video-container">' +
// 								'<i class="fa fa-video-camera fa-5 no-video-icon"></i>' +
// 								'<span class="no-video-text">No remote video available</span>' +
// 							'</div>');
// 					}
// 				} else {
// 					$('#videoremote'+remoteFeed.rfindex+ ' .no-video-container').remove();
// 					$('#remotevideo'+remoteFeed.rfindex).removeClass('hide').show();
// 				}
// 				if(!addButtons)
// 					return;
// 				if(Janus.webRTCAdapter.browserDetails.browser === "chrome" || Janus.webRTCAdapter.browserDetails.browser === "firefox" ||
// 						Janus.webRTCAdapter.browserDetails.browser === "safari") {
// 					$('#curbitrate'+remoteFeed.rfindex).removeClass('hide').show();
// 					bitrateTimer[remoteFeed.rfindex] = setInterval(function() {
// 						// Display updated bitrate, if supported
// 						var bitrate = remoteFeed.getBitrate();
// 						$('#curbitrate'+remoteFeed.rfindex).text(bitrate);
// 						// Check if the resolution changed too
// 						var width = $("#remotevideo"+remoteFeed.rfindex).get(0).videoWidth;
// 						var height = $("#remotevideo"+remoteFeed.rfindex).get(0).videoHeight;
// 						if(width > 0 && height > 0)
// 							$('#curres'+remoteFeed.rfindex).removeClass('hide').text(width+'x'+height).show();
// 					}, 1000);
// 				}
			},
			oncleanup: function() {
				const rawId = remoteFeed.rfid || remoteFeed.getId();
			    const index = remoteFeed.rfindex;
			    const id = `rf${rawId}`;

			    Janus.log(" ::: Got a cleanup notification (remote feed " + id + ") :::");
			    
			    // remote box DOM 제거
				$(`#remote-box-${id}`).remove();
			    
				 // 비트레이트 타이머 제거
				if (bitrateTimer[id]) {
				    clearInterval(bitrateTimer[id]);
				    bitrateTimer[id] = null;
				}
				
				// Spinner 정리
				if(remoteFeed.spinner)
					remoteFeed.spinner.stop();
				remoteFeed.spinner = null;
				
				// feeds 배열에서 해당 feed 제거
				feeds[remoteFeed.rfindex] = null;
				
				// 기타 남은 UI 요소 제거
				$('#remotevideo'+remoteFeed.rfindex).remove();
				$('#waitingvideo'+remoteFeed.rfindex).remove();
				$('#novideo'+remoteFeed.rfindex).remove();
				$('#curbitrate'+remoteFeed.rfindex).remove();
				$('#curres'+remoteFeed.rfindex).remove();
				if(bitrateTimer[remoteFeed.rfindex])
					clearInterval(bitrateTimer[remoteFeed.rfindex]);
				bitrateTimer[remoteFeed.rfindex] = null;
				remoteFeed.simulcastStarted = false;
				$('#simulcast'+remoteFeed.rfindex).remove();
				console.log("Unpublished");
				$('#videolocal').empty();
				$('#publish').show();
				$('#remoteContainer').empty();

				
				console.log(`👋 feed ${id} cleanup 완료`);
				
			}
		});
}



</script>

</body>
</html>