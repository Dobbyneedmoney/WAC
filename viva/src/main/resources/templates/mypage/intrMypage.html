<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<script src="https://code.jquery.com/jquery-latest.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:src="@{/js/memformEdit.js}"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script	th:src="@{https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.min.js}"></script>
<script th:src="@{/js/webRtc/janus.js}"></script>
  
<meta charset="UTF-8">
<title>면접관 마이페이지</title>
<link rel="stylesheet" th:href="@{/css/main.css}">
<link rel="stylesheet" th:href="@{/css/common.css}">
<link rel="stylesheet" th:href="@{/css/reservation.css}">
<link rel="stylesheet" th:href="@{/css/memberformEdit.css}">
<style>

.content-card {
  background: #fff;                           /* 흰색 배경 */
  padding: 24px 85px;                         /* 내부 여백 */
  border-radius: 8px;                         /* 둥근 모서리 */
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);   /* 은은한 그림자 */
  margin-bottom: 24px;                        /* 아래쪽 여백 */
}
    
body {
	background: #f7f9fc;
	font-family: 'Segoe UI', '맑은 고딕', sans-serif;
	margin: 0;
	padding: 0;
}

.mypage-layout {
	display: flex;
	max-width: 1100px;
	margin: 50px auto 0 auto;
	min-height: 550px;
	background: #fff;
	border-radius: 14px;
	box-shadow: 0 2px 14px rgba(70, 110, 180, 0.08);
	overflow: visible; /* 또는 auto 로 바꿔보세요 */
}
/* 사이드바 */
.sidebar {
	width: 230px;
	background: #f9f6f1; 
	padding: 36px 0 0 0;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.sidebar-menu {
	display: flex;
	flex-direction: column;
	gap: 5px;
	padding-left: 24px;
}

.sidebar-menu a {
	font-size: 17px;
	color: #5a4220;  /* 진한 브라운 글씨 */
	text-decoration: none;
	padding: 10px 0 10px 12px;
	border-radius: 5px 0 0 5px;
	transition: background 0.18s;
	font-weight: 500;
	letter-spacing: -0.2px;
}

.sidebar-menu a.active, 
.sidebar-menu a:hover {
	background: #edd3b3;
	color: black;
	font-weight: bold;
}

.sidebar-bottom {
	padding-left: 24px;
	padding-bottom: 38px;
}

.sidebar-bottom a {
	color: #d34040;
	font-weight: bold;
	text-decoration: none;
	font-size: 15px;
	transition: color 0.2s;
}

.sidebar-bottom a:hover {
	color: #b80000;
	text-decoration: underline;
}
/* 메인컨텐츠 */
.main-content {
	flex: 1;
	padding: 46px 44px;
	background: #f7f9fc;
	min-width: 0;
	height: auto; /* 높이를 자동으로 */
	overflow-y: auto; /* 세로 스크롤 자동 생성 */
	width:1100px;
	justify-content: center;
}

.info-cards {
	display: flex;
	gap: 36px;
}

.member-info {
	background: #fff;
	border-radius: 9px;
	box-shadow: 0 2px 8px rgba(135, 160, 180, 0.07);
	padding: 32px 38px 30px 38px;
	min-width: 320px;
	flex: 1;
	margin-bottom: 24px;
}

.member-info h2 {
	margin-top: 0;
	font-size: 21px;
	color: #314266;
	margin-bottom: 16px;
}

.member-info-list {
	font-size: 16px;
	line-height: 2.1;
	color: #222;
}

.stat-info {
	background: #f2f6fb;
	border-radius: 9px;
	box-shadow: 0 2px 8px rgba(70, 110, 180, 0.06);
	padding: 32px 40px;
	min-width: 220px;
	display: flex;
	flex-direction: column;
	justify-content: center;
	margin-bottom: 24px;
}

.stat-info h2 {
	margin-top: 0;
	font-size: 20px;
	color: #2951a3;
	margin-bottom: 18px;
}

.stat-info .point-value {
	font-size: 25px;
	color: #314266;
	font-weight: bold;
	margin-bottom: 8px;
}

@media ( max-width : 900px) {
	.mypage-layout {
		flex-direction: column;
	}

	.sidebar {
		width: 100%;
		flex-direction: row;
		padding: 0;
	}
	.main-content {
		padding: 24px 10px;
	}
	.info-cards {
		flex-direction: column;
		gap: 14px;
	}
}
	 .btn-exchange {
  margin-top: 10px;
  padding: 8px 16px;
  font-size: 0.95rem;
  font-weight: 600;
  color: #fff;
  background-color: #5b7fd3;
  border: none;
  border-radius: 6px;     /* 살짝 둥글게 */
  cursor: pointer;
  transition: background-color 0.2s;
}


</style>
</head>
<body>
	<div th:replace="fragments/header :: header"></div>

	<div class="mypage-layout">
		<!-- 사이드바 -->
		<nav class="sidebar">
			<div>
				<div class="sidebar-menu">
					<a th:href="@{/mypage}">내 정보</a>
					<a th:href="@{/memberEdit}" id="memberEdit">내 정보 수정</a>
					<a th:href="@{/intrReview}" id="intrReview">후기 관리</a> 
					<!-- 이슬 수정 -->
					<a href="#" id="menuSchedule">일정관리</a>
					<!-- 이슬 수정 -->
					<a href="#" id="loadExchangeList">환전 내역</a>
					<a th:href="@{/jobsite}">취업 사이트</a>
				</div>
			</div>
			<div class="sidebar-bottom">
				<!-- 페이지 이동 없이 자바스크립트로만 동작 -->
				<a href="#" id="withdrawBtn"
					style="color: #d34040; text-decoration: underline;">회원 탈퇴</a>
			</div>
		</nav>

		<!-- 메인 컨텐츠 -->
		<section class="main-content" id="contentArea">
			<!--id="contentArea" 추가-s -->
			<div class="info-cards">
				<!-- 회원 정보 -->
				<div class="member-info">
					<h2>회원 정보</h2>
					<div class="member-info-list">
						<div>
							<strong>아이디:</strong> <span th:text="${users.userId}">intr1</span>
						</div>
						<div>
							<strong>이름:</strong> <span th:text="${users.userName}">홍면접</span>
						</div>
						<div>
							<strong>핸드폰번호:</strong> <span th:text="${users.userNum}">010-0000-0000</span>
						</div>
						<div>
							<strong>이메일:</strong> <span th:text="${users.userEmail}">intr@naver.com</span>
						</div>
						<div>
							<strong>주소:</strong> <span
								th:text="${users.userAdd + ' ' + users.userAddDetail}">주소+상세주소</span>
						</div>
						<div>
							<strong>가입일:</strong> <span th:text="${users.createdDt}">2025-06-27</span>
						</div>
					</div>
				</div>
				<!-- 포인트만 표시하는 활동통계 -->
				<div class="stat-info">
					<h2>나의 포인트</h2>
					<div class="point-value" th:text="${point + 'P'}">
						<!--  <div th:text="${point + 'P'}"></div> -->
					</div>
					<!--환전 버튼 추가 -->
					<button id="exchangeBtn" type="button" class="btn-exchange">
					  포인트 환전하기
					</button>
					<!-- 예: 환전 모달을 넣을 페이지 -->
					<div th:replace="mypage/exchangeModal :: exchangeModal"></div>
				</div>
			</div>
			
			 <!-- 마이페이지 내정보 수정 -->
        	<div id="editContainer" style="display:none; width:100%; justify-content:center;"></div>
        	
			<!-- ✅ 일정 관리 영역 (Ajax로 로드) -->
			<!-- <div id="contentArea">
				여기에 fragment가 동적으로 들어옴
			</div> -->

			<!-- 환전내역 컨테이너 -->
			<div id="exchangeListContainer" style="display: none;">
				<!-- 여기에 프래그먼트 내용이 로드됩니다 -->
			</div>
		</section>
	</div>


	<!-- 탈퇴 팝업 Modal (처음에는 display:none; 숨겨둠) -->
	<div id="withdrawModal"
		style="display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.25); z-index: 9999;">
		<div
			style="background: #fff; width: 350px; margin: 120px auto; padding: 32px 24px 16px 24px; border-radius: 10px; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.16); position: relative;">
			<h2 style="margin-bottom: 18px;">정말로 탈퇴하시겠습니까?</h2>
			<form id="withdrawForm">
				<!-- 비밀번호 입력 -->
				<div style="margin-bottom: 10px;">
					<label>현재 비밀번호</label><br> <input type="password"
						name="currentPass" style="width: 100%;" required />
				</div>
				<div style="margin-bottom: 18px;">
					<label>비밀번호 확인</label><br> <input type="password"
						name="confirmPass" style="width: 100%;" required />
				</div>
				<!-- 버튼 영역 -->
				<div style="display: flex; justify-content: space-between;">
					<button type="submit"
						style="background: #d34040; color: #fff; border: none; padding: 7px 20px; border-radius: 5px;">확인</button>
					<button type="button" id="cancelWithdraw"
						style="background: #ccc; color: #222; border: none; padding: 7px 20px; border-radius: 5px;">취소</button>
				</div>
			</form>
		</div>
	</div>

	<!-- 회원정보 수정 후 메세지 -->
	<script th:if="${editSuccess != null}" th:inline="javascript">
		alert('[[${editSuccess}]]');
	</script>


<script>
// 공통함수
function hideAllFragments() {
	  $('#exchangeListContainer,#editContainer, #activityContainer, #reviewContainer, #jasoContainer, #exchangeBtn, #paymentListContainer').hide();
	  $('.member-info, .stat-info').hide();
	}
</script>
<script>
$(function() {
	// 1. "회원 탈퇴" 링크 클릭 시 팝업 열기
	$("#withdrawBtn").on("click", function(e) {
		e.preventDefault(); // 링크 기본동작 막기(새로고침X)
		$("#withdrawModal").show();
	});

	// 2. 취소 버튼 클릭 시 팝업 닫기
	$("#cancelWithdraw").on("click", function() {
		$("#withdrawModal").hide();
		$("#withdrawForm")[0].reset(); // 입력값 초기화
	});

	// 3. 폼 제출(확인) 시 AJAX로 탈퇴 요청
	$("#withdrawForm").on("submit", function(e) {
		e.preventDefault();

		// 입력값 가져오기
		var currentPass = $("input[name='currentPass']").val();
		var confirmPass = $("input[name='confirmPass']").val();

		// 1차 체크: 비밀번호 일치 확인
		if (currentPass !== confirmPass) {
			alert("비밀번호가 일치하지 않습니다.");
			return;
		}

		// AJAX로 서버에 탈퇴 요청
		$.ajax({
			type : "POST",
			url : "/member/withdraw", // 컨트롤러 매핑에 맞춰서
			data : {
				currentPass : currentPass
			},
			success : function(result) {
				if (result === "success") {
					alert("회원 탈퇴가 완료되었습니다.");
					window.location.href = "/main"; // 탈퇴 후 이동할 페이지
				} else if (result === "fail") {
					alert("비밀번호가 틀립니다.");
				} else {
					alert("오류가 발생했습니다. 다시 시도해주세요.");
				}
			},
			error : function() {
				alert("요청 처리 중 오류가 발생했습니다.");
			}
		});
	});
});
</script>
<!-- 이슬면접관 마이페이지 -->
<!-- ✅ 일정 관리 fragment 로드 -->
<script>
$(function() {
  $("#menuSchedule").on("click", function(e) {
    e.preventDefault();

    // 1) 메뉴 토글
    $(".sidebar-menu a").removeClass("active");
    $(this).addClass("active");

    // 2) 기존 화면 초기화
    hideAllFragments();
    $('#contentArea').show();

    // 3) 컨테이너에 card 래퍼 생성
    $('#contentArea').html('<div class="content-card" id="scheduleCard"></div>');

    // 4) 스케줄 프래그먼트 로드
    $("#scheduleCard").load("/reservation/intrmypage", function(response, status, xhr) {
      if (status === "success") {
        console.log("✅ 일정관리 fragment 로드 성공");

        // flatpickr 초기화
        flatpickr("#datePicker", {
          dateFormat: "Y-m-d",
          minDate: "today"
        });
      } else {
        console.error("❌ fragment 로드 실패", status, xhr.status, xhr.statusText);
      }
    });
  });
});
</script>
<!-- <script>
$(function() {
	$("#menuSchedule").on("click",function(e) {
		e.preventDefault();
	
	// 기존 active 제거 후 현재 메뉴에 적용
	$(".sidebar-menu a").removeClass("active");
	$(this).addClass("active");

	 // 예원 추가	>>	수정폼 fragment 숨기기해야 메뉴 클릭시 호출됨
	hideAllFragments();  // 추가. 숨기는 코드가 먼저 와야 함. 
	$('#contentArea').show();
		// fragment 로드
		$("#contentArea").load("/reservation/intrmypage",function(response, status, xhr) {
			if (status === "success") {
				console.log("✅ fragment 로드 성공");
	
				// flatpickr 초기화
				flatpickr("#datePicker", {
					dateFormat : "Y-m-d",
					minDate : "today"
				});
			} else {
				console.error("❌ fragment 로드 실패",	status, xhr.status,	xhr.statusText);
			}
		});
	});
});
</script> -->
<!-- 환전쓰 -->
<script>
$(function() {
	$("#exchangeBtn").on("click", function() {
		$("#exchangeModal").show();
	});
	$(document).on("click", "#cancelExchange", function() {
		$("#exchangeModal").hide();
		$("#exchangeForm")[0].reset();
	});
});

$(function() {
	$("#exchangeForm").on("submit", function(e) {
		e.preventDefault();

		// 폼 데이터 객체로 수집
		const data = {
			name : $("input[name='name']").val(),
			phone : $("input[name='phone']").val(),
			bank: $("select[name='bank']").val(),
			account : $("input[name='account']").val(),
			amount : parseInt($("input[name='amount']").val(), 10)
		};

		$.ajax({
			url : "/point/exchange/request",
			type : "POST",
			contentType : "application/json",
			data : JSON.stringify(data),
			success : function(response) {
				if (response.success) {
					alert(response.message);
					$("#exchangeModal").hide();
					$("#exchangeForm")[0].reset();
					// 포인트 표시 부분 업데이트
			        // 기존 포인트 읽기
			        let currentPointStr = $(".point-value").text();  // 예: "12345P"
			        let currentPoint = parseInt(currentPointStr.replace("P", ""), 10);

			        let newPoint = currentPoint - data.amount;
			        if (newPoint < 0) newPoint = 0;

			        $(".point-value").text(newPoint + "P");
				} else {
					alert("실패: " + response.message);
				}
			},
			error : function() {
				alert("서버 요청 중 오류가 발생했습니다.");
			}
		});
	});
});
</script>
<script>
// 환전 메뉴탭
$(function() {
  $("#loadExchangeList").on("click", function(e) {
    e.preventDefault();

    // 탭 활성화 토글
    $(".sidebar-menu a").removeClass("active");
    $(this).addClass("active");

    // 기존 화면 초기화
    hideAllFragments();

    // contentArea를 보이게 하고, 카드(wrapper) 생성
    $('#contentArea')
      .show()
      .html('<div class="content-card" id="exchangeCard"></div>');

    // AJAX로 fragment 가져와서 card 안에 삽입
    $.ajax({
      url: "/mypage/exchange-list-fragment",
      success: function(data) {
        $("#exchangeCard").html(data);
        console.log("✅ 환전내역 fragment 로드 성공");
      },
      error: function(xhr) {
        console.error("❌ fragment 로드 실패", xhr.status, xhr.statusText);
        alert("환전 내역 로드 실패: " + xhr.statusText);
      }
    });
  });
});
	
//내정보 수정
$(function() {
$('#memberEdit').on('click', function(e){
	e.preventDefault();
	
	console.log("click");
	
  $('.sidebar-menu a').removeClass('active');
  $(this).addClass('active');
  hideAllFragments();  // ✅ 추가
  	
  $('.member-info, .stat-info').hide();
  $("#contentArea").css('display','flex').load('/memberEdit', function(resp, status, xhr){
	  
	console.log("memberEdit");
	  
    if(status !== 'success') {
      $('#editContainer').html('<div>불러오기 실패</div>');
      return;
    }
    // ★★★★★ 동적으로 들어온 폼에 이벤트를 다시 연결
    bindEmailDomainEvents();
  });
});
});



//면접관 리뷰 프래그먼트
$(function() {
	    $("#intrReview").on("click", function(e) {
	      e.preventDefault();

	      // 공통 초기화
	      hideAllFragments();

	      // 활성 메뉴 스타일 적용
	      $(".sidebar-menu a").removeClass("active");
	      $(this).addClass("active");

	      // 후기관리 fragment 로드
	      $("#contentArea").css("display", "flex").load("/intrReview/fragment", function(response, status, xhr) {
	        if (status === "success") {
	          console.log("✅ 후기 fragment 로드 성공");
	        } else {
	          console.error("❌ 후기 fragment 로드 실패", status, xhr.status, xhr.statusText);
	        }
	      });
	    });
	  });
</script>
<!-- Footer -->
  <div th:replace="fragments/footer :: footerFragment"></div>

</body>
</html>
