<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>면접관 상세</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <!-- 1) 면접관 기본 정보 -->
  <h1 th:text="${interviewer.name}">면접관 이름</h1>
  <p th:text="${interviewer.profile}">프로필 정보</p>
  <button id="btn-book">예약하기</button>

  <!-- 2) 예약 모달 (숨겨놓고 버튼 클릭 시 띄움) -->
  <div id="modal" style="display:none; position:fixed; top:20%; left:30%; background:#fff; padding:20px; border:1px solid #ccc;">
    <h3>날짜 선택</h3>
    <input type="date" id="selDate" />

    <h3>시간 선택</h3>
    <div id="timeSlots"></div>

    <button id="btn-confirm">확인</button>
    <button id="btn-cancel">취소</button>
  </div>

  <script th:inline="javascript">
    /* ===== 1) 버튼으로 모달 열기/닫기 ===== */
    const modal       = document.getElementById('modal');
    const btnBook     = document.getElementById('btn-book');
    const btnCancel   = document.getElementById('btn-cancel');
    let selectedDate, selectedTime;

    btnBook.onclick   = () => modal.style.display = 'block';
    btnCancel.onclick = () => modal.style.display = 'none';

    /* ===== 2) 날짜 선택 시 가능한 시간 받아오기 ===== */
    document.getElementById('selDate').onchange = async (e) => {
      selectedDate = e.target.value; // "2025-07-04"
      // API 호출: /api/reservations/availability?interviewerId=...&date=YYYY-MM-DD
      const slots = (await axios.get(
        `/api/reservations/availability`, {
          params: {
            interviewerId: /*[[${interviewer.id}]]*/ 'I123',
            date: selectedDate
          }
        }
      )).data;

      // 버튼으로 렌더링
      const container = document.getElementById('timeSlots');
      container.innerHTML = '';
      slots.forEach(t => {
        const b = document.createElement('button');
        b.textContent = t; // "10:00"
        b.onclick = () => {
          selectedTime = t;
          // 선택 강조
          Array.from(container.children).forEach(x=>x.style.border='1px solid #ccc');
          b.style.border = '2px solid blue';
        };
        container.appendChild(b);
      });
    };

    /* ===== 3) 확인 눌렀을 때 예약+결제 준비 ===== */
    document.getElementById('btn-confirm').onclick = async () => {
      // 1) 예약 생성
      const res = await axios.post('/api/reservations', {
        userId: /*[[${#httpSession.getAttribute('userId')}]]*/ 'U456',
        interviewerId: /*[[${interviewer.id}]]*/ 'I123',
        reservedAt: `${selectedDate}T${selectedTime}:00`
      });
      const reservation = res.data;  // { resId: 100, ... }

      // 2) 결제 준비
      const pay = await axios.post('/api/payments/prepare', {
        resNo: reservation.resId,
        amount: /*[[${interviewer.fee}]]*/ 50000
      });
      const payment = pay.data; // { payId: 200, payAmount: 50000, ... }

      // 3) 포인트 충전(결제) 페이지로 이동
      location.href = `/payments/charge?payId=${payment.payId}&amount=${payment.payAmount}`;
    };
  </script>
</body>
</html>
